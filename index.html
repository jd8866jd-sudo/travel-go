<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#60A5FA">
    <title>Travel Go!!!</title>

    <link rel="icon" type="image/png" href="icon.png">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Travel Go">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üß≥</text></svg>">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        window.onerror = function(msg, url, line) {
            if(msg.includes('ResizeObserver')) return false;
            return false;
        };
    </script>

    <style>
        :root { --theme-color: #60A5FA; }
        
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            overflow: hidden; position: fixed; 
            font-family: 'Zen Maru Gothic', sans-serif; 
            background-color: #222; color: #4A4A4A; 
            overscroll-behavior: none; 
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        #app { 
            background-color: #F0F9FF; width: 100%; max-width: 480px; 
            height: 100%; height: 100dvh;      
            display: flex; flex-direction: column; position: relative; 
            box-shadow: 0 0 20px rgba(0,0,0,0.5); margin: 0 auto;      
            overflow: hidden;  
            background-image: url("data:image/svg+xml,%3Csvg width='240' height='240' viewBox='0 0 240 240' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000' opacity='0.06'%3E%3Cpath transform='scale(1.2) translate(-10, -10)' d='M40 40c-3 0-5-3-5-6s2-6 5-6 5 3 5 6-2 6-5 6zm-8-2c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm16 0c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm-8 10c4 0 7-3 8-6 0-4-3-8-8-8s-8 4-8 8c1 3 4 6 8 6z'/%3E%3Cpath transform='translate(160, 20) scale(1.1)' d='M40 40c-3 0-5-3-5-6s2-6 5-6 5 3 5 6-2 6-5 6zm-8-2c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm16 0c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm-8 10c4 0 7-3 8-6 0-4-3-8-8-8s-8 4-8 8c1 3 4 6 8 6z'/%3E%3C/g%3E%3Cg transform='translate(130, 130) scale(1.8)' opacity='0.12'%3E%3Cpath d='M10 15 Q25 5 40 15 Q48 25 45 35 Q42 45 25 45 Q8 45 5 35 Q2 25 10 15 L8 2 L18 10 M32 10 L42 2 L38 15' fill='%232B2B2B' stroke='%232B2B2B' stroke-width='2' stroke-linejoin='round'/%3E%3Cpath d='M11 11 L9 4 L16 9 Z' fill='%23E4B886'/%3E%3Cpath d='M39 11 L41 4 L34 9 Z' fill='%23E4B886'/%3E%3Cpath d='M5 28 Q15 22 25 28 Q35 22 45 28 Q46 38 40 42 Q25 48 10 42 Q4 38 5 28' fill='white'/%3E%3Cellipse cx='16' cy='18' rx='2.5' ry='1.5' fill='%23E4B886'/%3E%3Cellipse cx='34' cy='18' rx='2.5' ry='1.5' fill='%23E4B886'/%3E%3Ccircle cx='18' cy='24' r='2' fill='black'/%3E%3Ccircle cx='32' cy='24' r='2' fill='black'/%3E%3Cellipse cx='25' cy='30' rx='2.5' ry='2' fill='black'/%3E%3Cpath d='M25 32 L25 34' stroke='black' stroke-width='0.5'/%3E%3Cpath d='M22 34 Q25 37 28 34' fill='none' stroke='black' stroke-width='1'/%3E%3Ccircle cx='10' cy='32' r='2' fill='%23FFAB91' opacity='0.5'/%3E%3Ccircle cx='40' cy='32' r='2' fill='%23FFAB91' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        header { flex-shrink: 0; z-index: 20; }
        main { flex: 1; overflow: hidden; position: relative; z-index: 10; display: flex; flex-direction: column; }
        nav { position: absolute; bottom: 0; left: 0; right: 0; z-index: 30; }

        .theme-bg { background-color: var(--theme-color) !important; color: white !important; transition: background-color 0.2s; }
        .theme-text { color: var(--theme-color) !important; transition: color 0.2s; }
        .theme-border { border-color: var(--theme-color) !important; transition: border-color 0.2s; }
        .theme-ring:focus { --tw-ring-color: var(--theme-color) !important; ring-color: var(--theme-color) !important; box-shadow: 0 0 0 2px var(--theme-color) !important; }
        
        .date-active { background-color: var(--theme-color) !important; color: white !important; border-color: var(--theme-color) !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .flight-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px dashed var(--theme-color); position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; margin-bottom: 0.75rem; }
        .watermark { position: absolute; top: 40px; left: 0; right: 0; text-align: center; font-size: 10px; font-weight: bold; color: #aaa; opacity: 0.5; pointer-events: none; z-index: 1; letter-spacing: 1px; user-select: none; }
        .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9CA3AF; transition: all 0.2s; font-size: 10px; font-weight: bold; }
        .bottom-nav-item.active { color: var(--theme-color); transform: translateY(-2px); }
        .suggestion-list { position: absolute; background: white; width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 0 0 8px 8px; z-index: 60; box-shadow: 0 4px 6px rgba(0,0,0,0.1); left: 0; top: 100%; }
        .suggestion-item { padding: 8px 12px; font-size: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background-color: #f9fafb; }
        
        .sticky-left { position: sticky; left: 0; z-index: 10; margin-right: 0.75rem !important; }
        .sticky-left::after { content: ''; position: absolute; top: 0; right: -10px; width: 10px; height: 100%; background: linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,0)); pointer-events: none; }

        .fab-btn { position: absolute; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--theme-color); color: white; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 25; transition: transform 0.2s; cursor: pointer; }
        .fab-btn:active { transform: scale(0.9); }

        .scroll-area { flex: 1; overflow-y: auto; padding-bottom: 100px; padding-left: 1.25rem; padding-right: 1.25rem; -webkit-overflow-scrolling: touch; }
        .fixed-header { flex-shrink: 0; padding-left: 1.25rem; padding-right: 1.25rem; background: transparent; z-index: 15; }

        .image-preview { width: 100%; height: 150px; background-color: #f3f4f6; border-radius: 12px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-top: 10px; border: 2px dashed #e5e7eb; position: relative; cursor: pointer; }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        
        /* Icon Buttons Styling */
        .action-btn { color: #9CA3AF; padding: 8px; transition: all 0.2s; font-size: 1.1rem; }
        .action-btn:hover { color: var(--theme-color); transform: scale(1.1); }
        .action-btn.delete:hover { color: #EF4444; }

        /* Current Item Pulse Animation */
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0.4); }
            70% { box-shadow: 0 0 0 6px rgba(96, 165, 250, 0); }
            100% { box-shadow: 0 0 0 0 rgba(96, 165, 250, 0); }
        }
        .current-active-item {
            border-color: var(--theme-color) !important;
            border-width: 2px !important;
            background-color: #EFF6FF !important; /* bg-blue-50 */
            animation: pulse-border 2s infinite;
        }

        #loading-mask { position: fixed; inset: 0; background: #F0F9FF; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-mask">
    <i class="fa-solid fa-plane fa-bounce text-4xl text-blue-400 mb-4"></i>
    <div class="text-gray-500 font-bold">ËºâÂÖ•‰∏≠...</div>
</div>

<div id="app">
    <div class="watermark">Copyright¬© 2025 Eugenie Teng</div>

    <header v-if="!isPickingLocation" class="px-6 pt-8 pb-2 z-20 bg-transparent flex-shrink-0">
        <div class="flex justify-between items-center mb-4">
            <div class="flex-1 mr-3">
                <h1 class="text-2xl font-bold theme-text tracking-wide truncate">{{ settings.title }}</h1>
                <p class="text-[10px] text-gray-400 tracking-wider">V9.0 Êô∫ÊÖßÂçáÁ¥öÁâà <span v-if="autoSaveStatus" class="ml-1 text-green-500"><i class="fa-solid fa-check"></i> Â∑≤ÂêåÊ≠•</span></p>
            </div>
            <div class="flex gap-2">
                <button @click="modals.calc = true" class="w-10 h-10 rounded-xl bg-white text-gray-400 shadow-sm flex items-center justify-center hover:bg-gray-50"><i class="fa-solid fa-calculator"></i></button>
                <button @click="modals.settings = true" class="w-10 h-10 rounded-xl bg-white text-gray-400 shadow-sm flex items-center justify-center hover:bg-gray-50"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>

        <div v-if="['itinerary', 'wallet'].includes(currentView)" class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2">
            <div v-if="currentView === 'wallet'" @click="selectDay('dashboard')" class="sticky-left flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === 'dashboard' }">
                <span class="text-xs font-bold">Á∏ΩË¶Ω</span><i class="fa-solid fa-building-columns mt-1"></i>
            </div>

            <div v-if="currentView === 'itinerary'" @click="selectDay(-1)" class="sticky-left flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === -1 }">
                <span class="text-xs font-bold">PRE</span><i class="fa-solid fa-clipboard-check mt-1"></i>
            </div>

            <div v-if="currentView === 'wallet'" @click="selectDay(-1)" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === -1 }">
                <span class="text-xs font-bold">PRE</span><i class="fa-solid fa-clipboard-check mt-1"></i>
            </div>

            <div v-for="(dateObj, index) in computedDates" :key="index" @click="selectDay(index)"
                class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm relative"
                :class="{ 'date-active': selectedDayIdx === index }">
                <div v-if="dateObj.isToday" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
                <span class="text-xs font-bold">{{ dateObj.dayLabel }}</span>
                <span class="text-[10px] font-medium whitespace-nowrap">{{ dateObj.dateLabel }}</span>
            </div>
            <div v-if="currentView === 'wallet'" @click="selectDay('summary')" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === 'summary' }">
                <span class="text-xs font-bold">Á∏ΩÁµê</span><i class="fa-solid fa-chart-pie mt-1"></i>
            </div>
        </div>
    </header>

    <main>
        <div v-if="currentView === 'itinerary'" class="flex flex-col h-full">
            <div class="fixed-header pb-2">
                <div v-if="selectedDayIdx === -1" class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold theme-text">Ë°åÂâçÊ∫ñÂÇô</h2>
                    <button @click="importPackingList" class="text-xs theme-bg text-white px-3 py-1.5 rounded-full shadow-sm">üì• ÂåØÂÖ•Ê∏ÖÂñÆ</button>
                </div>
                <div v-else class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-dark">Ë°åÁ®ãÂÆâÊéí</h2>
                    <div class="flex space-x-2">
                         <button v-if="currentActivityId && isTodaySelected" @click="scrollToActive" class="bg-red-50 text-red-500 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-red-100 animate-bounce"><i class="fa-solid fa-location-crosshairs mr-1"></i> ÁèæÂú®</button>
                         <button @click="generateDayRoute" class="bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-blue-200"><i class="fa-solid fa-map-location-dot mr-1"></i> Á∏ΩË¶Ω</button>
                         <button @click="copyItinerary" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-gray-200"><i class="fa-regular fa-copy mr-1"></i> Ë§áË£Ω</button>
                         <button @click="addFlightToDay" class="bg-purple-100 text-purple-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-purple-200"><i class="fa-solid fa-plane mr-1"></i> Ëà™Áè≠</button>
                    </div>
                </div>
            </div>

            <div class="scroll-area hide-scrollbar">
                <div v-if="selectedDayIdx === -1" class="space-y-3 pt-1">
                    <div v-for="todo in todoList" :key="todo.id" class="flex items-center bg-white p-4 rounded-2xl shadow-sm"><input type="checkbox" v-model="todo.done" class="w-5 h-5 theme-text rounded focus:ring-0 cursor-pointer"><input v-model="todo.text" class="ml-3 flex-1 outline-none text-sm text-gray-700" :class="{'line-through text-gray-300': todo.done}"><button @click="deleteTodo(todo.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                    <button @click="addTodo" class="w-full py-3 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 text-sm hover:border-gray-400 transition"><i class="fa-solid fa-plus mr-1"></i> Êñ∞Â¢ûÂæÖËæ¶</button>
                </div>
                <div v-else ref="sortableList" class="space-y-3 pt-1 min-h-[100px]">
                    <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-map-location text-4xl mb-3"></i><p>ÈªûÊìäÂè≥‰∏ãÊñπ + Êñ∞Â¢ûË°åÁ®ã</p></div>
                    <div v-for="(item, index) in currentItinerary" :key="item.id || item.code" :data-id="item.id" :id="'item-'+item.id">
                        <div v-if="item.isFlight" @click="openFlightModal(item.type, item)" class="flight-card" :class="{ 'current-active-item': item.id === currentActivityId }">
                             <div v-if="item.id === currentActivityId" class="absolute top-0 left-1/2 transform -translate-x-1/2 bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-b-lg font-bold z-10 shadow-sm"><i class="fa-solid fa-fire mr-1"></i>ÈÄ≤Ë°å‰∏≠</div>
                            <div class="flex justify-between text-xs text-gray-400 font-bold mb-1"><span>{{ item.title }}</span><span>{{ item.from }} <i class="fa-solid fa-plane mx-1"></i> {{ item.to }}</span></div>
                            <div class="flex justify-between items-end">
                                <div class="text-3xl font-bold theme-text">{{ item.time }}</div>
                                <div class="flex flex-col items-center justify-center w-full px-2">
                                    <div v-if="isNextDay(item)" class="text-[10px] text-red-500 font-bold mb-0.5">+{{ getDayDiff(item) }}Êó•</div>
                                    <div class="text-[10px] font-bold theme-text mb-1 bg-blue-50 px-2 py-0.5 rounded-full"><i class="fa-regular fa-clock mr-1"></i>{{ getFlightDuration(item) }}</div>
                                    <div class="text-2xl font-bold text-gray-600">{{ item.code }}</div>
                                </div>
                                <div class="text-3xl font-bold theme-text">{{ item.arriveTime }}</div>
                            </div>
                            <div class="mt-1 text-xs text-gray-400 font-bold text-center border-t border-gray-100 pt-1 flex justify-between items-center">
                                <span class="flex-1 text-left text-blue-500 font-mono">{{ item.bookingRef || '' }}</span>
                                <span class="flex-1 text-center">{{ item.airline || 'Ëà™Á©∫ÂÖ¨Âè∏' }}</span>
                                <span class="flex-1 text-right text-green-500 font-mono">{{ item.ticketNo || '' }}</span>
                            </div>
                        </div>
                        <div v-else class="bg-white rounded-[24px] p-4 shadow-sm relative group border-l-4 transition hover:shadow-md" :class="[getCategoryColor(item.category), {'current-active-item': item.id === currentActivityId}]">
                            <div v-if="item.id === currentActivityId" class="absolute -top-3 left-4 bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full font-bold z-10 shadow-sm"><i class="fa-solid fa-fire mr-1"></i>ÈÄ≤Ë°å‰∏≠</div>
                            <div class="absolute right-4 top-4 text-gray-300 cursor-grab handle"><i class="fa-solid fa-grip-lines"></i></div>
                            <div class="flex items-start">
                                <div class="mr-2 pt-1 flex flex-col items-center w-11 text-center">
                                    <div class="bg-gray-100 text-gray-600 text-[11px] font-bold px-1 py-1 rounded-lg mb-2 font-mono">{{ item.time }}</div>
                                    <i :class="[getCategoryIcon(item.category), 'text-xl text-gray-400']"></i>
                                </div>
                                <div class="flex-1 pr-6">
                                    <h3 class="font-bold text-gray-700 text-lg leading-tight mb-1">{{ item.location }}</h3>
                                    <p class="text-xs text-gray-400 line-clamp-2 mb-2">{{ item.note }}</p>
                                    <div class="flex flex-nowrap items-center gap-1 mt-2 overflow-x-auto hide-scrollbar pb-1">
                                        <button v-if="item.image" @click.stop="openImageModal(item.image)" class="action-btn"><i class="fa-regular fa-image"></i></button>
                                        <button @click="editItem(item)" class="action-btn"><i class="fa-solid fa-pen"></i></button>
                                        <button @click="deleteItem(item.id)" class="action-btn delete"><i class="fa-solid fa-trash-can"></i></button>
                                        <div class="ml-2 flex gap-1">
                                            <button @click="copyItemToDay(item)" class="flex-shrink-0 text-[10px] bg-yellow-50 text-yellow-600 px-3 py-1.5 rounded-full hover:bg-yellow-200 whitespace-nowrap">Ë§áË£Ω</button>
                                            <a :href="getNavUrl(item)" target="_blank" class="flex-shrink-0 text-[10px] bg-green-50 text-green-600 px-3 py-1.5 rounded-full font-bold flex items-center hover:bg-green-100 whitespace-nowrap"><i class="fa-solid fa-location-arrow mr-1"></i> </a>
                                            <button v-if="index > 0 && !currentItinerary[index-1].isFlight" @click="planRouteFromPrev(item, index)" class="flex-shrink-0 text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-bold flex items-center hover:bg-blue-100 whitespace-nowrap"><i class="fa-solid fa-route mr-1"></i> </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button v-if="selectedDayIdx !== -1" @click="openItemModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'wallet'" class="flex flex-col h-full">
            <div class="fixed-header pb-2">
                <div class="flex justify-between items-center mb-2 px-1">
                    <h2 class="text-xl font-bold theme-text whitespace-nowrap">ÊóÖË≤ªË®òÂ∏≥</h2>
                    <div class="flex gap-1">
    <button @click="modals.group = true" class="text-xs bg-white text-gray-500 px-2 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center whitespace-nowrap">
        <i class="fa-solid fa-users mr-1"></i> ÊóÖ‰º¥Áæ§ÁµÑ
    </button>
    <button @click="modals.budget = true" class="text-xs bg-white text-gray-500 px-2 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center whitespace-nowrap">
        <i class="fa-solid fa-pen mr-1"></i> È†êÁÆó
    </button>
    <button @click="exportReport" class="text-xs bg-green-50 text-green-600 px-2 py-1.5 rounded-full shadow-sm border border-green-200 flex items-center whitespace-nowrap">
        <i class="fa-solid fa-file-export mr-1"></i> ÂåØÂá∫Â†±Ë°®
    </button>
</div>
                </div>

                <div v-if="selectedDayIdx === 'dashboard'" class="space-y-4 animate-fade-in-up">
                    <div class="bg-white rounded-3xl p-5 shadow-lg border border-gray-100 relative">
                        <div class="flex justify-between items-center mb-3">
                            <div class="text-gray-400 text-xs font-bold flex items-center"><i class="fa-solid fa-piggy-bank mr-1"></i> Á∏ΩÈ†êÁÆó (TWD)</div>
                            <div class="text-2xl font-bold theme-text">{{ settings.budget.toLocaleString('zh-TW') }}</div>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div class="h-2.5 rounded-full transition-all duration-500" :class="getBudgetBgClass()" :style="{width: `${Math.min(100, Math.max(0, tripStats.percentage))}%`}"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs font-bold text-gray-500">
                            <span>Â∑≤Ëä±Ë≤ª(Á∏ΩÂÄº): {{ tripStats.spent.toLocaleString('zh-TW') }}</span>
                            <span :class="getBudgetColorClass()">Ââ©È§ò(Á∏ΩÂÄº): {{ tripStats.remaining.toLocaleString('zh-TW') }}</span>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-5 shadow-lg border border-blue-100 relative">
                         <div class="flex justify-between items-center mb-3">
                            <div class="text-blue-700 text-xs font-bold flex items-center"><i class="fa-solid fa-wallet mr-1"></i> ÊàëÁöÑÈå¢ÂåÖ (ÊåÅÊúâÁèæÈáë)</div>
                         </div>
                         <div class="grid grid-cols-1 gap-2">
                            <div v-for="(info, curr) in walletHoldings" :key="curr" class="bg-white/60 p-2 rounded-lg flex justify-between items-center border border-blue-100/50">
                                <span class="text-xs font-bold text-gray-500 w-12">{{ curr }}</span>
                                <div class="flex-1 flex justify-between items-center">
                                    <span class="font-mono font-bold theme-text text-sm">{{ info.amount.toLocaleString() }}</span>
                                    <span v-if="curr !== 'TWD' && info.rate" class="text-[10px] text-gray-400 bg-white/80 px-1.5 py-0.5 rounded ml-2 whitespace-nowrap">ÂåØÁéá: {{ info.rate }}</span>
                                </div>
                            </div>
                         </div>
                    </div>

                    <div v-if="publicFundStats && Object.keys(publicFundStats).length > 0" class="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-3xl p-5 shadow-lg border border-yellow-200 relative">
                         <div class="flex justify-between items-center mb-3">
                            <div class="text-yellow-700 text-xs font-bold flex items-center"><i class="fa-solid fa-sack-dollar mr-1"></i> ÂÖ¨Ë≤ªË≥áÈáëÊ±† (È§òÈ°ç)</div>
                         </div>
                         <div class="grid grid-cols-2 gap-2">
                            <div v-for="(amt, curr) in publicFundStats" :key="curr" class="bg-white/60 p-2 rounded-lg flex justify-between items-center border border-yellow-100/50">
                                <span class="text-xs font-bold text-gray-500">{{ curr }}</span>
                                <span class="font-mono font-bold" :class="amt < 0 ? 'text-red-500' : 'theme-text'">{{ amt.toLocaleString() }}</span>
                            </div>
                         </div>
                    </div>
                </div>

                <div v-if="selectedDayIdx === 'summary'" class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-dark">Á∏ΩËä±Ë≤ªÁµ±Ë®à</h3>
                    <select v-model="summaryFilter" class="text-xs bg-gray-100 p-1 rounded border-none outline-none">
                        <option value="all">ÂÖ®ÈÉ®ÂàÜÈ°û</option>
                        <option v-for="cat in Object.keys(categoryLabels)" :key="cat" :value="cat">{{ categoryLabels[cat] }}</option>
                    </select>
                </div>
                <div v-if="selectedDayIdx !== 'summary' && selectedDayIdx !== 'dashboard'" class="flex justify-between items-center mb-4">
                      <h3 class="text-lg font-bold text-dark">
                        {{ selectedDayIdx === -1 ? 'Ë°åÂâçËä±Ë≤ª' : '‰ªäÊó•Ëä±Ë≤ª' }}: TWD {{ dayTotalTwd.toLocaleString('zh-TW') }}
                    </h3>
                </div>
            </div>

            <div class="scroll-area hide-scrollbar">
                <div v-if="selectedDayIdx === 'dashboard'" class="px-2 pt-4 text-center text-gray-400 text-xs">
                    <i class="fa-solid fa-arrow-down mr-1"></i> Ë´ãÈÅ∏ÊìáÊó•ÊúüÊü•ÁúãË©≥Á¥∞ÊòéÁ¥∞
                </div>

                <div v-if="selectedDayIdx === 'summary'">
                     <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-2 mb-4">
                        <div v-for="({cat, amt}) in categories" :key="cat" class="flex items-center text-[10px] bg-gray-50 px-2 py-1 rounded-lg flex-shrink-0"><div class="w-2 h-2 rounded-full mr-1" :style="{backgroundColor: getCategoryHex(cat)}"></div>{{ getCategoryLabel(cat) }} {{ Math.round(amt/tripTotalTwd*100) }}%</div>
                    </div>
                    <div v-if="calculatedTransfers.length > 0" class="mb-4 bg-yellow-50 rounded-2xl p-4 border border-yellow-200 relative overflow-hidden">
                        <div class="absolute -right-2 -top-2 bg-yellow-100 text-yellow-600 text-[10px] px-2 py-1 rounded-bl-xl font-bold">Smart Debt</div>
                        <h3 class="text-sm font-bold text-yellow-800 mb-2 flex items-center"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ÂàÜÂ∏≥Êô∫ÊÖßÁµêÁÆó (TWDÔºå‰∏çÂê´ÂÖ¨Ë≤ªÔºåÂ∑≤ÂÑ™ÂåñË∑ØÂæë)</h3>
                        <div class="text-[10px] text-yellow-600 mb-2">Á≥ªÁµ±Â∑≤Ëá™ÂãïÁ∞°ÂåñËΩâÂ∏≥Ë∑ØÂæë (‰æãÂ¶Ç A‚ÜíB, B‚ÜíC Á∞°ÂåñÁÇ∫ A‚ÜíC)</div>
                        <div class="space-y-1">
                            <div v-for="t in calculatedTransfers" :key="t.from+t.to" class="text-xs flex items-center bg-white/50 p-2 rounded-lg">
                                <span class="font-bold text-red-600">{{ t.from }}</span> 
                                <span class="mx-1 text-gray-400"><i class="fa-solid fa-arrow-right"></i></span>
                                <span class="font-bold text-green-600">{{ t.to }}</span>
                                <div class="flex-1 border-b border-dotted border-gray-300 mx-2"></div>
                                <span class="font-mono font-bold theme-text">{{ t.amount.toLocaleString('zh-TW') }}</span>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-3 pb-2">
                        <div v-for="ex in filteredSummaryExpenses" :key="ex.id" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :style="{borderColor: getCategoryHex(ex.category)}" :class="{'opacity-75': ex.category === 'exchange'}">
                            <div class="flex-1 mr-4">
                                <div class="text-sm font-bold" :class="ex.category === 'exchange' ? 'text-gray-500' : 'text-gray-700'">
                                    {{ ex.item }}
                                    <span v-if="ex.category === 'exchange'" class="ml-2 text-[10px] bg-gray-200 text-gray-600 px-1.5 py-0.5 rounded">Ë≥áÁî¢ËΩâÊèõ</span>
                                    <span v-if="ex.paymentMethod === 'card'" class="ml-2 text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded"><i class="fa-regular fa-credit-card"></i></span>
                                </div>
                                <div class="text-[10px] text-gray-400 flex flex-wrap mt-1">
                                    <span class="mr-2 bg-gray-100 px-1 rounded">{{ ex.date }}</span>
                                    <span class="mr-1 font-bold">{{ ex.payer }}</span>
                                    <span v-if="ex.category !== 'exchange'">ÂÖà‰ªò <span class="text-gray-500">({{ ex.forWhom.length === settings.travelers.length ? 'Âπ≥ÂàÜ' : ex.forWhom.join(', ') }})</span></span>
                                </div>
                            </div>
                            <div class="text-right">
                                <div v-if="ex.category !== 'exchange'">
                                    <div class="text-sm font-bold font-mono theme-text">{{ ex.currency }} {{ ex.amount }}</div>
                                    <div v-if="ex.currency !== 'TWD'" class="text-[10px] text-gray-400">‚âà {{ getExpenseCostInTwd(ex) }}</div>
                                </div>
                                <div v-else class="text-xs text-gray-400">Ë≥áÁî¢ËΩâÊèõ</div>
                            </div>
                        </div>
                         <div v-if="filteredSummaryExpenses.length===0" class="text-center text-gray-300 py-4">ÁÑ°Ë≥áÊñô</div>
                    </div>
                </div>
                <div v-if="selectedDayIdx !== 'summary' && selectedDayIdx !== 'dashboard'">
                      <div class="space-y-3 pb-2 min-h-[50px]">
                        <div v-if="currentDayExpenses.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-receipt text-4xl mb-3"></i><p>ÈªûÊìäÂè≥‰∏ãËßí + Êñ∞Â¢ûËä±Ë≤ª</p></div>
                        <div v-for="ex in currentDayExpenses" :key="ex.id" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :style="{borderColor: getCategoryHex(ex.category)}" :class="{'opacity-75': ex.category === 'exchange'}">
                            <div class="flex-1 mr-4">
                                <div class="text-sm font-bold" :class="ex.category === 'exchange' ? 'text-gray-500' : 'text-gray-700'">
                                    {{ ex.item }}
                                    <span v-if="ex.category === 'exchange'" class="ml-2 text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">
                                        <i class="fa-solid fa-arrow-right-arrow-left mr-1"></i>
                                        {{ ex.currency }} {{ ex.amount }} ‚ûú {{ ex.targetCurrency }} {{ ex.targetAmount }}
                                    </span>
                                    <span v-if="ex.paymentMethod === 'card'" class="ml-2 text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded"><i class="fa-regular fa-credit-card"></i></span>
                                </div>
                                <div class="text-[10px] text-gray-400 flex flex-wrap mt-1">
                                    <span class="mr-1 font-bold">{{ ex.payer }}</span>
                                    <span v-if="ex.category !== 'exchange'">ÂÖà‰ªò <span class="text-gray-500">({{ ex.forWhom.length === settings.travelers.length ? 'Âπ≥ÂàÜ' : ex.forWhom.join(', ') }})</span></span>
                                </div>
                            </div>
                            <div class="flex items-center">
                                <div class="text-right mr-3">
                                    <div v-if="ex.category !== 'exchange'">
                                        <div class="text-sm font-bold font-mono theme-text">{{ ex.currency }} {{ ex.amount }}</div>
                                        <div v-if="ex.currency !== 'TWD'" class="text-[10px] text-gray-400">‚âà {{ getExpenseCostInTwd(ex) }}</div>
                                    </div>
                                    <div v-else class="text-xs text-gray-400 font-bold">Ë≥áÁî¢ËΩâÊèõ</div>
                                </div>
                                <button @click="openExpenseModal(ex)" class="text-gray-300 hover:text-blue-400 p-1 mr-1"><i class="fa-solid fa-pen"></i></button>
                                <button @click="deleteExpense(ex.id)" class="text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <button v-if="selectedDayIdx !== 'summary' && selectedDayIdx !== 'dashboard'" @click="openExpenseModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'shopping'" class="flex flex-col h-full">
            <div class="fixed-header pb-2">
                <h2 class="text-xl font-bold theme-text mb-2">Ë≥ºÁâ©Ê∏ÖÂñÆ</h2>
            </div>
            <div class="scroll-area hide-scrollbar">
                <div class="space-y-3 pt-1">
                    <div v-if="shoppingList.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-cart-shopping text-4xl mb-3"></i><p>ÈªûÊìä + Êñ∞Â¢ûË≥ºÁâ©È†ÖÁõÆ</p></div>
                    <div v-for="item in shoppingList" :key="item.id" class="flex items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :class="item.done ? 'border-gray-200' : 'theme-border'">
                        <input type="checkbox" v-model="item.done" class="w-5 h-5 theme-text rounded focus:ring-0 cursor-pointer" :class="{'opacity-50': item.done}">
                        <div class="ml-3 flex-1 flex items-center justify-between cursor-pointer" @click="openShopModal(item)">
                            <span class="text-sm text-gray-700 block" :class="{'line-through text-gray-300': item.done}">{{ item.text }}</span>
                        </div>
                        <div class="flex items-center">
                            <button v-if="item.image" @click.stop="openImageModal(item.image)" class="action-btn"><i class="fa-regular fa-image"></i></button>
                            <button @click="openShopModal(item)" class="action-btn"><i class="fa-solid fa-pen"></i></button>
                            <button @click="deleteShopItem(item.id)" class="action-btn delete"><i class="fa-solid fa-trash-can"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <button @click="openShopModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'info'" class="flex flex-col h-full">
            <div class="fixed-header pb-2">
                 <h2 class="text-xl font-bold theme-text mb-4">Ë≥áË®äÁ´ô</h2>
                
                <div class="theme-bg rounded-3xl p-3 text-white shadow-sm mb-2 flex items-stretch justify-between relative overflow-hidden min-h-[80px]">
                    <button @click="fetchWeather" class="absolute top-1 right-1 text-white/70 hover:text-white text-[10px] z-20 px-2 py-1"><i class="fa-solid fa-rotate-right" :class="{'fa-spin': weather.loading}"></i></button>

                    <div class="flex flex-col justify-center z-10 pr-2 pl-1">
                        <div class="text-[10px] opacity-80 mb-0.5 flex items-center"><i class="fa-solid fa-location-dot mr-1"></i> {{ weather.location || 'ÂÆö‰Ωç‰∏≠...' }}</div>
                       <div class="text-4xl font-bold leading-none mb-1">{{ weather.temp }}¬∞</div>
<div class="text-sm font-medium">{{ weather.desc }}</div>
                        <div class="text-[10px] mt-1 opacity-90"><i class="fa-solid fa-umbrella mr-1"></i>ÈôçÈõ® {{ weather.rain || 0 }}%</div>
                    </div>

                    <div v-if="weather.forecast && weather.forecast.length" class="flex items-center space-x-1 z-10 border-l border-white/20 pl-2 ml-auto">
                        <div v-for="(day, idx) in weather.forecast" :key="idx" class="flex flex-col items-center justify-center w-14 py-1">
                            <div class="text-[9px] opacity-80 mb-1">{{ day.label }}</div>
                            <i :class="getWeatherIcon(day.code)" class="text-lg mb-1"></i>
                            <div class="text-[10px] font-bold leading-none mb-0.5">{{ day.min }}¬∞-{{ day.max }}¬∞</div>
                            <div class="text-[8px] opacity-80 scale-90"><i class="fa-solid fa-umbrella mr-0.5"></i>{{ day.rain }}%</div>
                        </div>
                    </div>
                    <div v-else class="flex items-center justify-center w-48 text-xs opacity-60 ml-auto border-l border-white/20">
                        ËºâÂÖ•È†êÂ†±...
                    </div>
                </div>

            </div>

            <div class="scroll-area hide-scrollbar">
                <div class="space-y-3 pt-1">
                     <div v-for="info in infoList" :key="info.id" class="bg-white p-5 rounded-2xl shadow-sm border-l-4 theme-border relative group">
                        <div class="flex justify-between items-start">
                            <h3 class="text-lg font-bold text-gray-700">{{ info.title }}</h3>
                            <div class="text-gray-300 flex space-x-1 items-center">
                                <button v-if="info.image" @click="openImageModal(info.image)" class="action-btn"><i class="fa-regular fa-image"></i></button>
                                <button @click="editInfo(info)" class="action-btn"><i class="fa-solid fa-pen"></i></button>
                                <button @click="deleteInfo(info.id)" class="action-btn delete"><i class="fa-solid fa-trash-can"></i></button>
                            </div>
                        </div>
                        <pre class="text-sm text-gray-500 whitespace-pre-wrap mt-1">{{ info.content }}</pre>
                    </div>
                    <div v-if="infoList.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-circle-info text-4xl mb-3"></i><p>ÁÑ°Ë≥áË®ä</p></div>
                </div>
            </div>
             <button @click="openInfoModal()" class="fab-btn"><i class="fa-solid fa-plus"></i></button>
        </div>

        <div v-if="currentView === 'translate'" class="flex flex-col h-full">
             <div class="fixed-header pb-2">
                <h2 class="text-xl font-bold theme-text mb-4">Âç≥ÊôÇÁøªË≠Ø</h2>
                 <textarea v-model="transText" @input="debouncedTranslate" placeholder="Ëº∏ÂÖ•Ë¶ÅÁøªË≠ØÁöÑÂÖßÂÆπ (ÊîØÊè¥‰∏≠Êñá/Ëã±/Êó•/Èüì)" class="w-full h-32 bg-white rounded-3xl p-5 shadow-sm outline-none text-lg resize-none mb-4 border-2 border-transparent focus:border-gray-200"></textarea>
             </div>
             <div class="scroll-area hide-scrollbar">
                 <div class="space-y-4">
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 theme-border relative group">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-xs text-gray-400 font-bold">JAPANESE</div>
                            <button @click="speak(translations.ja, 'ja-JP')" class="text-gray-400 hover:text-theme transition"><i class="fa-solid fa-volume-high"></i></button>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.ja)">{{ translations.ja || '...' }}</div>
                        <button @click="openFullscreen(translations.ja)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-blue-400 relative group">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-xs text-gray-400 font-bold">ENGLISH</div>
                            <button @click="speak(translations.en, 'en-US')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-volume-high"></i></button>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.en)">{{ translations.en || '...' }}</div>
                        <button @click="openFullscreen(translations.en)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                    </div>
                    <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-green-400 relative group">
                        <div class="flex justify-between items-start mb-1">
                            <div class="text-xs text-gray-400 font-bold">KOREAN</div>
                            <button @click="speak(translations.ko, 'ko-KR')" class="text-gray-400 hover:text-green-600 transition"><i class="fa-solid fa-volume-high"></i></button>
                        </div>
                        <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.ko)">{{ translations.ko || '...' }}</div>
                        <button @click="openFullscreen(translations.ko)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                    </div>
                </div>
             </div>
        </div>
    </main>

    <nav class="absolute bottom-0 left-0 right-0 h-16 bg-white shadow-2xl z-30 flex items-center px-4 rounded-t-3xl border-t border-gray-100">
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'itinerary' }" @click="switchView('itinerary')"><i class="fa-solid fa-map-location-dot"></i><span>Ë°åÁ®ã</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'wallet' }" @click="switchView('wallet')"><i class="fa-solid fa-wallet"></i><span>Ë®òÂ∏≥</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'shopping' }" @click="switchView('shopping')"><i class="fa-solid fa-cart-shopping"></i><span>Ë≥ºÁâ©</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'info' }" @click="switchView('info')"><i class="fa-solid fa-circle-info"></i><span>Ë≥áË®ä</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'translate' }" @click="switchView('translate')"><i class="fa-solid fa-language"></i><span>ÁøªË≠Ø</span></div>
    </nav>
    
    <div v-if="modals.item" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.item = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold theme-text mb-4">{{ editingItem ? 'Á∑®ËºØË°åÁ®ã' : 'Êñ∞Â¢ûË°åÁ®ã' }}</h3>
            <div class="space-y-4">
                <div class="flex space-x-3">
                    <div class="flex-1"><label class="text-xs text-gray-400">ÊôÇÈñì (24H)</label><div class="flex space-x-1 items-center"><select v-model="form.hour" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring text-sm font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span class="text-gray-400">:</span><select v-model="form.minute" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring text-sm font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                    <div class="flex-1"><label class="text-xs text-gray-400">Âú∞Èªû <span class="text-[10px] text-red-400 ml-1 font-bold">* (ÂøÖÂ°´)</span></label><input v-model="form.location" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                </div>
                <div><label class="text-xs text-gray-400">ÂàÜÈ°û</label><select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"><option value="travel">‚úàÔ∏è ‰∫§ÈÄö</option><option value="food">üçΩÔ∏è È§êÈ£≤</option><option value="accommodation">üè® ‰ΩèÂÆø</option><option value="activity">üèÉ Ê¥ªÂãï</option><option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option><option value="other">üí° ÂÖ∂‰ªñ</option></select></div>
                <div>
                    <label class="text-xs text-gray-400">Á∂≤ÂùÄ</label>
                    <div class="flex space-x-2"><input v-model="urlInput" placeholder="Âú∞Ê®ôÂêçÁ®±/Á∂≤ÂùÄ" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring text-gray-700"><button @click="parseUrl" class="w-10 h-10 theme-bg text-white rounded-xl shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-magnifying-glass"></i></button></div>
                    <div v-if="urlStatus === 'success'" class="text-[10px] text-green-600 font-bold mt-1">ÈÄ£ÁµêÂ∑≤ÂÑ≤Â≠ò <span v-if="autoFilledName" class="theme-text">ÂêçÁ®±: {{ autoFilledName }}</span></div>
                </div>
                <div>
                    <label class="text-xs text-gray-400">ÂúñÁâá (ÈÅ∏Â°´)</label>
                    <button class="w-full bg-gray-50 p-3 rounded-xl text-sm text-gray-500 border border-dashed border-gray-300 hover:bg-gray-100 flex items-center justify-center relative">
                        <i class="fa-solid fa-image mr-2"></i> {{ form.image ? 'Êõ¥ÊèõÂúñÁâá' : '‰∏äÂÇ≥ÂúñÁâá' }}
                        <input type="file" accept="image/*" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" @change="(e) => handleImageUpload(e, form)">
                    </button>
                    <div v-if="form.image" class="image-preview" @click="openImageModal(form.image)">
                        <img :src="form.image">
                        <button @click.stop="form.image = null" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
                    </div>
                </div>
                <div><label class="text-xs text-gray-400">ÂÇôË®ª</label><textarea v-model="form.note" rows="2" class="w-full bg-gray-50 p-3 rounded-xl outline-none resize-none focus:ring-2 theme-ring"></textarea></div>
            </div>
            <div class="flex space-x-3 mt-6"><button @click="modals.item = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">ÂèñÊ∂à</button><button @click="saveItem" class="flex-1 py-3 rounded-xl theme-bg font-bold text-sm shadow-lg hover:opacity-90">ÂÑ≤Â≠ò</button></div>
        </div>
    </div>

    <div v-if="modals.expense" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.expense = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold theme-text mb-4">{{ editingExpenseId ? 'Á∑®ËºØËä±Ë≤ª' : 'Êñ∞Â¢ûËä±Ë≤ª' }}</h3>
            <div class="space-y-4">
                 <div><label class="text-xs text-gray-400">È†ÖÁõÆ</label><input v-model="newExpense.item" placeholder="ÂìÅÈ†Ö (Â¶Ç: ÊôöÈ§ê)" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                 
                 <div><label class="text-xs text-gray-400">ÂàÜÈ°û</label><select v-model="newExpense.category" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"><option value="food">üçΩÔ∏è È§êÈ£≤</option><option value="traffic">üöó ‰∫§ÈÄö</option><option value="accommodation">üè® ‰ΩèÂÆø</option><option value="shopping">üõçÔ∏è Ë≥ºÁâ©</option><option value="entertainment">üé° Â®õÊ®Ç</option><option value="other">üí° ÂÖ∂‰ªñ</option><option value="exchange">üí± ÊèõÂåØ (Èå¢ÂåÖËΩâÂ∏≥)</option></select></div>

                 <div v-if="newExpense.category !== 'exchange'">
                     <div class="flex space-x-3 mb-2">
                        <div class="flex-1"><label class="text-xs text-gray-400">ÈáëÈ°ç</label><input type="number" v-model="newExpense.amount" placeholder="ÈáëÈ°ç" class="w-full bg-gray-50 p-3 rounded-xl text-lg outline-none focus:ring-2 theme-ring font-bold text-gray-700" min="0"></div>
                        <div class="w-1/3"><label class="text-xs text-gray-400">Âπ£Âà•</label><select v-model="newExpense.currency" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center"><option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option></select></div>
                     </div>
                     <div class="text-right mb-2 text-xs font-bold text-gray-400" v-if="newExpense.currency !== 'TWD' && newExpense.amount">‚âà TWD {{ getExpenseCostInTwd(newExpense).toLocaleString() }}</div>
                     <div class="mb-4">
                        <label class="text-xs text-gray-400">ÊîØ‰ªòÊñπÂºè</label>
                        <div class="flex bg-gray-100 rounded-xl p-1">
                            <button @click="newExpense.paymentMethod = 'cash'" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all" :class="newExpense.paymentMethod === 'cash' ? 'bg-white shadow text-gray-700' : 'text-gray-400'">üíµ ÁèæÈáë</button>
                            <button @click="newExpense.paymentMethod = 'card'" class="flex-1 py-2 text-xs rounded-lg font-bold transition-all" :class="newExpense.paymentMethod === 'card' ? 'bg-white shadow text-gray-700' : 'text-gray-400'">üí≥ Âà∑Âç°/Êï∏‰Ωç</button>
                        </div>
                     </div>

                     <div>
                         <label class="text-xs text-gray-400 mb-1 block">Ë™∞‰ªòÁöÑÔºü</label>
                         <div class="flex flex-wrap gap-2"><button v-for="p in settings.travelers" :key="p" @click="newExpense.payer = p" class="px-3 py-2 text-xs rounded-xl transition-colors font-bold border" :class="newExpense.payer === p ? 'theme-bg border-transparent' : 'bg-white text-gray-500 border-gray-200'">{{ p }}</button></div>
                     </div>
                     <div class="mt-4">
                         <label class="text-xs text-gray-400 mb-1 block">Ë™∞Ëä±ÁöÑÔºü</label>
                         <div class="flex flex-wrap gap-2"><button v-for="p in settings.travelers" :key="p" @click="toggleSplit(p)" class="px-3 py-2 text-xs rounded-xl transition-colors font-bold border flex items-center" :class="newExpense.forWhom.includes(p) ? 'theme-bg border-transparent' : 'bg-white text-gray-500 border-gray-200'">{{ p }} <i v-if="newExpense.forWhom.includes(p)" class="fa-solid fa-check ml-1 text-[10px]"></i></button></div>
                     </div>
                 </div>

                 <div v-else class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                     <p class="text-xs text-blue-500 mb-2 font-bold"><i class="fa-solid fa-circle-info mr-1"></i> Ê≠§Á¥ÄÈåÑÂ∞áË®àÁÆóÊÇ®ÁöÑÊåÅÊúâÊàêÊú¨</p>
                     <div class="flex space-x-3 items-end mb-3">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400">‰ªòÂá∫ (‰æÜÊ∫ê)</label>
                            <input type="number" v-model="newExpense.amount" placeholder="‰ªòÂá∫ÈáëÈ°ç" class="w-full bg-white p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700">
                        </div>
                        <div class="w-1/3">
                            <select v-model="newExpense.currency" class="w-full bg-white p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center"><option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option></select>
                        </div>
                     </div>
                     <div class="flex justify-center text-blue-300 my-1"><i class="fa-solid fa-arrow-down"></i></div>
                     <div class="flex space-x-3 items-end">
                        <div class="flex-1">
                            <label class="text-xs text-gray-400">ÊèõÂà∞ (ÁõÆÊ®ô)</label>
                            <input type="number" v-model="newExpense.targetAmount" placeholder="Áç≤ÂæóÈáëÈ°ç" class="w-full bg-white p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700">
                        </div>
                        <div class="w-1/3">
                            <select v-model="newExpense.targetCurrency" class="w-full bg-white p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center"><option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option></select>
                        </div>
                     </div>
                 </div>
            </div>
             <div class="flex space-x-3 mt-6"><button @click="modals.expense = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">ÂèñÊ∂à</button><button @click="saveExpense" class="flex-1 py-3 rounded-xl theme-bg font-bold text-sm shadow-lg hover:opacity-90">ÂÑ≤Â≠ò</button></div>
        </div>
    </div>

    <div v-if="modals.shopping" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.shopping = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold theme-text mb-4">{{ editingShopItem ? 'Á∑®ËºØÈ†ÖÁõÆ' : 'Êñ∞Â¢ûÈ†ÖÁõÆ' }}</h3>
             <input v-model="newShopItem" @keyup.enter="saveShopItem" placeholder="Ëº∏ÂÖ•Ë≥ºÁâ©ÂÖßÂÆπ..." class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700 mb-4">
             <div class="mb-4">
                 <button class="w-full bg-gray-50 p-3 rounded-xl text-sm text-gray-500 border border-dashed border-gray-300 hover:bg-gray-100 flex items-center justify-center relative">
                     <i class="fa-solid fa-image mr-2"></i> {{ tempShopImage ? 'Êõ¥ÊèõÂúñÁâá' : '‰∏äÂÇ≥ÂúñÁâá' }}
                     <input type="file" accept="image/*" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" @change="(e) => handleImageUpload(e, null, 'shop')">
                 </button>
                 <div v-if="tempShopImage" class="image-preview" @click="openImageModal(tempShopImage)">
                     <img :src="tempShopImage">
                     <button @click.stop="tempShopImage = null" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
                 </div>
             </div>
             <div class="flex space-x-3"><button @click="modals.shopping = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">ÂèñÊ∂à</button><button @click="saveShopItem" class="flex-1 py-3 rounded-xl theme-bg font-bold text-sm shadow-lg hover:opacity-90">ÂÑ≤Â≠ò</button></div>
        </div>
    </div>

    <div v-if="modals.info" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.info = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
             <h3 class="text-lg font-bold theme-text mb-4">{{ editingInfoId ? 'Á∑®ËºØË≥áË®ä' : 'Êñ∞Â¢ûË≥áË®ä' }}</h3>
             <input v-model="newInfo.title" placeholder="Ê®ôÈ°å (Â¶Ç: È£ØÂ∫óWifiÂØÜÁ¢º)" class="w-full mb-3 bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700">
             <textarea v-model="newInfo.content" placeholder="ÂÖßÂÆπ..." rows="5" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none resize-none focus:ring-2 theme-ring text-gray-700 mb-4"></textarea>
             <div class="mb-4">
                 <button class="w-full bg-gray-50 p-3 rounded-xl text-sm text-gray-500 border border-dashed border-gray-300 hover:bg-gray-100 flex items-center justify-center relative">
                     <i class="fa-solid fa-image mr-2"></i> {{ newInfo.image ? 'Êõ¥ÊèõÂúñÁâá' : '‰∏äÂÇ≥ÂúñÁâá' }}
                     <input type="file" accept="image/*" class="absolute inset-0 opacity-0 w-full h-full cursor-pointer" @change="(e) => handleImageUpload(e, newInfo)">
                 </button>
                 <div v-if="newInfo.image" class="image-preview" @click="openImageModal(newInfo.image)">
                     <img :src="newInfo.image">
                     <button @click.stop="newInfo.image = null" class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center"><i class="fa-solid fa-times"></i></button>
                 </div>
             </div>
             <div class="flex space-x-3"><button @click="modals.info = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">ÂèñÊ∂à</button><button @click="saveInfo" class="flex-1 py-3 rounded-xl theme-bg font-bold text-sm shadow-lg hover:opacity-90">ÂÑ≤Â≠ò</button></div>
        </div>
    </div>

    <div v-if="modals.settings" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.settings = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold mb-4 text-center">Ë®≠ÂÆö</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-gray-400">Ë°åÁ®ãÂêçÁ®±</label><input v-model="settings.title" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                <div class="flex space-x-3"><div class="flex-1"><label class="text-xs text-gray-400">Âá∫ÁôºÊó•Êúü</label><input type="date" v-model="settings.startDate" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div><div class="flex-1"><label class="text-xs text-gray-400">ÁµêÊùüÊó•Êúü</label><input type="date" v-model="settings.endDate" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div></div>
                <div><label class="text-xs text-gray-400 block mb-1">‰∏ªÈ°åËâ≤</label><div class="flex space-x-3"><button @click="changeColor('#60A5FA')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#60A5FA]"></button><button @click="changeColor('#F97316')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#F97316]"></button><button @click="changeColor('#EF4444')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#EF4444]"></button><button @click="changeColor('#00B894')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#00B894]"></button><button @click="changeColor('#4ADE80')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#4ADE80]"></button><button @click="changeColor('#C084FC')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#C084FC]"></button></div></div>
                <hr class="border-gray-100">
                <h4 class="text-sm font-bold text-gray-600">ÂåØÁéáË®≠ÂÆö (TWD=1)</h4>
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="c in Object.keys(settings.rates)" :key="c" class="flex items-center space-x-2"><label class="w-10 text-sm font-mono text-gray-700 text-right">{{ c }}:</label><input type="text" :value="settings.rates[c]" disabled class="w-24 bg-gray-100 text-gray-500 p-2 rounded-xl text-sm outline-none font-bold text-center border border-gray-200 cursor-not-allowed"></div>
                </div>
                <div class="flex justify-between items-center text-[10px] text-gray-400 mt-1 px-1">
                    <span>Á≥ªÁµ±ÊØè60ÁßíËá™ÂãïÂà∑Êñ∞ <span class="text-blue-400 font-mono">(ÂÄíÊï∏ {{ rateCountdown }} Áßí)</span></span>
                    <span>ÊúÄÂæåÊõ¥Êñ∞: {{ lastRateUpdate || 'Â∞öÊú™' }}</span>
                </div>
                <button @click="manualUpdateRates" class="w-full py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> Á´ãÂç≥Êõ¥Êñ∞ÂåØÁéá</button>
                <hr class="border-gray-100">
                <div class="flex space-x-2"><button @click="exportData" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-gray-200"><i class="fa-solid fa-download mr-1"></i> ÂÇô‰ªΩ</button><button @click="triggerImport" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-gray-200"><i class="fa-solid fa-upload mr-1"></i> ÂåØÂÖ•</button><button @click="resetData" class="flex-1 py-2 bg-red-50 text-red-500 rounded-xl text-xs font-bold hover:bg-red-100"><i class="fa-solid fa-trash mr-1"></i> ÈáçÁΩÆ</button></div>
                <input type="file" ref="fileInput" accept=".json" class="hidden" @change="handleImport">
            </div>
            <div class="text-center mt-6"><button @click="modals.settings = false" class="text-sm font-bold theme-text">ÈóúÈñâ</button></div>
        </div>
    </div>

    <div v-if="modals.flight" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.flight = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold theme-text mb-4">Á∑®ËºØËà™Áè≠</h3>
            <div class="space-y-4 mb-4">
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex space-x-2 mb-2 relative">
                        <div class="w-1/2 relative">
                            <label class="text-[10px] text-gray-400">Âá∫ÁôºÂú∞</label>
                            <input v-model="tempFlight.from" @input="searchAirport(tempFlight.from, 'dep')" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-center uppercase text-sm" placeholder="‰ª£Ëôü/‰∏≠Êñá">
                            <div v-if="suggestions.type === 'dep' && suggestions.list.length > 0" class="suggestion-list">
                                <div v-for="s in suggestions.list" :key="s.code" @click="selectAirport(s, 'dep')" class="suggestion-item">
                                    <span class="font-bold">{{ s.code }}</span><span class="text-gray-500 ml-2">{{ s.cityZh }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-1/2 relative">
                            <label class="text-[10px] text-gray-400">ÁõÆÁöÑÂú∞</label>
                            <input v-model="tempFlight.to" @input="searchAirport(tempFlight.to, 'arr')" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-center uppercase text-sm" placeholder="‰ª£Ëôü/‰∏≠Êñá">
                             <div v-if="suggestions.type === 'arr' && suggestions.list.length > 0" class="suggestion-list">
                                <div v-for="s in suggestions.list" :key="s.code" @click="selectAirport(s, 'arr')" class="suggestion-item">
                                    <span class="font-bold">{{ s.code }}</span><span class="text-gray-500 ml-2">{{ s.cityZh }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <input v-model="tempFlight.airline" placeholder="Ëà™Á©∫ÂÖ¨Âè∏" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm text-center">
                        <input v-model="tempFlight.code" placeholder="Ëà™Áè≠‰ª£Ëôü" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm text-center">
                        <input v-model="tempFlight.bookingRef" placeholder="Ë®Ç‰Ωç‰ª£Ëôü" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm uppercase text-center">
                        <input v-model="tempFlight.ticketNo" placeholder="Ê©üÁ•®ËôüÁ¢º" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm text-center">
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">Âá∫ÁôºÊó•Êúü</label><input type="date" v-model="tempFlight.date" class="w-full bg-white p-1 rounded outline-none text-xs text-center font-bold"></div>
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">ÊäµÈÅîÊó•Êúü</label><input type="date" v-model="tempFlight.arriveDate" class="w-full bg-white p-1 rounded outline-none text-xs text-center font-bold"></div>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">Âá∫Áôº (24H)</label><div class="flex space-x-1 items-center"><select v-model="tempFlight.hour" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span>:</span><select v-model="tempFlight.minute" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">ÊäµÈÅî (24H)</label><div class="flex space-x-1 items-center"><select v-model="tempFlight.arriveHour" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span>:</span><select v-model="tempFlight.arriveMinute" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                    </div>
                    <button v-if="editingFlightItem" @click="removeFlightItem" class="mt-2 w-full text-xs text-red-400 border border-red-200 rounded py-1 hover:bg-red-50">ÁßªÈô§Ê≠§Ëà™Áè≠</button>
                </div>
            </div>
            <button @click="saveFlight" class="w-full py-3 theme-bg text-white rounded-xl font-bold text-sm shadow-md">ÂÑ≤Â≠ò</button>
        </div>
    </div>

    <div v-if="modals.image" class="fixed inset-0 bg-black/90 z-[100] flex items-center justify-center p-2" @click.self="modals.image = false">
        <button @click="modals.image = false" class="absolute top-4 right-4 text-white text-2xl w-10 h-10 flex items-center justify-center bg-gray-700/50 rounded-full"><i class="fa-solid fa-times"></i></button>
        <img :src="currentImage" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-lg">
    </div>

    <div v-if="modals.calc" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] flex items-center justify-center p-6" @click.self="modals.calc=false">
        <div class="bg-white w-full max-w-xs rounded-3xl p-5 shadow-2xl">
            <h3 class="text-center font-bold text-lg mb-3 theme-text">Âø´ÈÄüÊèõÁÆó</h3>
            <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                <div class="flex justify-between mb-1"><span class="text-xs text-gray-400">ÊèõÁÆóÁµêÊûú (TWD)</span><span class="font-bold text-lg theme-text font-mono">TWD {{ calcResult.toLocaleString('zh-TW') }}</span></div>
                <div class="flex justify-between items-center mt-3"><select v-model="calcCurrency" class="bg-white p-2 rounded-lg text-sm outline-none font-bold text-gray-700"><option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option></select><input type="number" v-model="calcInput" placeholder="Ëº∏ÂÖ•ÈáëÈ°ç" class="w-1/2 bg-white p-2 rounded-lg text-lg outline-none font-bold text-gray-700 text-right font-mono" min="0"></div>
            </div>
            <div class="text-center"><button @click="modals.calc=false" class="text-sm font-bold theme-text">ÈóúÈñâ</button></div>
        </div>
    </div>

    <div v-if="modals.fullscreen" class="fixed inset-0 bg-white z-[100] flex items-center justify-center overflow-hidden cursor-pointer" @click="modals.fullscreen=false">
        <div class="transform rotate-90 w-[100vh] h-[100vw] flex flex-col items-center justify-center p-10 bg-white absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2">
            <div class="text-[12vw] font-bold text-gray-800 text-center leading-tight break-words max-w-[90%]">
                {{ fullscreenText }}
            </div>
            <div class="mt-8 text-gray-400 text-sm font-bold animate-pulse">
                ÈªûÊìäËû¢ÂπïÈóúÈñâ
            </div>
        </div>
    </div>

    <div v-if="modals.group" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.group=false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">ÊóÖ‰º¥Áæ§ÁµÑÁÆ°ÁêÜ</h3>
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4">
                <button @click="togglePublicFund" class="w-full mb-3 py-2 rounded-xl text-xs font-bold shadow-sm border flex items-center justify-center transition" :class="settings.travelers.includes('ÂÖ¨Ë≤ª') ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : 'bg-white text-gray-500 border-gray-200'">
                    <i class="fa-solid fa-coins mr-2"></i> {{ settings.travelers.includes('ÂÖ¨Ë≤ª') ? 'ÁßªÈô§ÂÖ¨Ë≤ªË∫´ÂàÜ' : 'ÂïüÁî®ÂÖ¨Ë≤ªÁÆ°ÁêÜ' }}
                </button>
                <div class="flex flex-wrap gap-2 mb-3"><span v-for="(p, idx) in settings.travelers" :key="p" class="bg-white px-3 py-1.5 rounded-xl text-sm border flex items-center shadow-sm">{{ p }}<button v-if="idx>0 && p !== 'ÂÖ¨Ë≤ª'" @click="removeTraveler(idx)" class="ml-2 text-red-300 hover:text-red-500">√ó</button></span></div>
                <div class="flex gap-2"><input v-model="newTravelerName" @keyup.enter="addTraveler" placeholder="Êñ∞Â¢ûÊóÖ‰º¥ÂêçÁ®±..." class="flex-1 bg-white p-2 rounded-lg text-sm outline-none font-bold text-gray-700"><button @click="addTraveler" class="w-10 h-10 theme-bg text-white rounded-lg shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-plus text-lg"></i></button></div>
            </div>
            <div class="text-center"><button @click="modals.group=false" class="text-sm font-bold theme-text">ÈóúÈñâ</button></div>
        </div>
    </div>

    <div v-if="modals.budget" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.budget=false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">Á∑®ËºØÈ†êÁÆó</h3>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4"><label class="text-xs text-gray-400">Á∏ΩÈ†êÁÆó (TWD)</label><input type="number" v-model.number="settings.budget" placeholder="0" class="w-full bg-white p-3 rounded-xl text-2xl outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center" min="0"></div>
            <div class="text-center flex justify-end"><button @click="editBudget" class="py-2 px-6 theme-bg text-white rounded-xl font-bold text-sm shadow-md">ÂÑ≤Â≠ò</button></div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, nextTick, reactive, onMounted, watch } = Vue;

    // PWA Icon Setup
    if (!document.querySelector("link[rel='apple-touch-icon']")) {
        const link = document.createElement('link'); link.rel = 'apple-touch-icon'; link.href = 'icon.png'; document.head.appendChild(link);
        const link2 = document.createElement('link'); link2.rel = 'icon'; link2.type='image/png'; link2.href = 'icon.png'; document.head.appendChild(link2);
    }

    const airData = "TPE,Taipei,Âè∞Âåó,8|TSA,Taipei,Âè∞ÂåóÊùæÂ±±,8|KHH,Kaohsiung,È´òÈõÑ,8|NRT,Tokyo,Êù±‰∫¨ÊàêÁî∞,9|HND,Tokyo,Êù±‰∫¨ÁæΩÁî∞,9|KIX,Osaka,Â§ßÈò™,9|FUK,Fukuoka,Á¶èÂ≤°,9|OKA,Okinawa,Ê≤ñÁπ©,9|CTS,Sapporo,Êú≠Âπå,9|ICN,Seoul,È¶ñÁàæ‰ªÅÂ∑ù,9|GMP,Seoul,È¶ñÁàæÈáëÊµ¶,9|PUS,Busan,ÈáúÂ±±,9|CJU,Jeju,ÊøüÂ∑û,9|BKK,Bangkok,ÊõºË∞∑,7|DMK,Bangkok,ÊõºË∞∑ÂªäÊõº,7|HKG,Hong Kong,È¶ôÊ∏Ø,8|SIN,Singapore,Êñ∞Âä†Âù°,8|KUL,Kuala Lumpur,ÂêâÈöÜÂù°,8|SGN,Ho Chi Minh,ËÉ°ÂøóÊòé,7|HAN,Hanoi,Ê≤≥ÂÖß,7|MNL,Manila,È¶¨Â∞ºÊãâ,8|CEB,Cebu,ÂÆøÈúß,8|DPS,Bali,Â≥áÈáåÂ≥∂,8|LAX,Los Angeles,Ê¥õÊùâÁ£Ø,-8|SFO,San Francisco,ËàäÈáëÂ±±,-8|JFK,New York,Á¥êÁ¥Ñ,-5|LHR,London,ÂÄ´Êï¶,0|CDG,Paris,Â∑¥Èªé,1|AMS,Amsterdam,ÈòøÂßÜÊñØÁâπ‰∏π,1|FRA,Frankfurt,Ê≥ïËò≠ÂÖãÁ¶è,1|DXB,Dubai,ÊùúÊãú,4|SYD,Sydney,Èõ™Ê¢®,11|MEL,Melbourne,Â¢®ÁàæÊú¨,11|YVR,Vancouver,Ê∫´Âì•ËèØ,-8|YYZ,Toronto,Â§öÂÄ´Â§ö,-5|MUC,Munich,ÊÖïÂ∞ºÈªë,1|FCO,Rome,ÁæÖÈ¶¨,1|BCN,Barcelona,Â∑¥Â°ûÈöÜÁ¥ç,1|MAD,Madrid,È¶¨Âæ∑Èáå,1";
    const airports = airData.split('|').map(s => {
        const p = s.split(',');
        return { code: p[0], city: p[1], cityZh: p[2], tz: parseInt(p[3]) };
    });

    const app = createApp({
        setup() {
            const settings = reactive({ title: 'Travel Go!!!', startDate: new Date().toISOString().split('T')[0], endDate: new Date(Date.now()+3*86400000).toISOString().split('T')[0], rates: { JPY: 0.22, KRW: 0.024, USD: 32, TWD: 1 }, color: '#60A5FA', budget: 0, travelers: ['Êàë'] });
            const flights = reactive({ dep: { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 }, ret: { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 } });
            const itineraryData = ref({});
            const expenses = ref([]);
            const todoList = ref([{id:1, text:'ÂÖåÊèõÂ§ñÂπ£', done:false}, {id:2, text:'Ë≥ºË≤∑ÊóÖÈÅä‰øùÈö™', done:false}]);
            const shoppingList = ref([]);
            const infoList = ref([]);
            const modals = reactive({ item: false, settings: false, flight: false, calc: false, fullscreen: false, group: false, budget: false, expense: false, shopping: false, info: false, image: false });
            const currentView = ref('itinerary');
            const selectedDayIdx = ref(0);
            const form = ref({ id: null, hour: '10', minute: '00', location: '', category: 'activity', cost: null, note: '', sourceUrl: '', image: null });
            const editingItem = ref(null);
            const editingFlightItem = ref(null);
            const urlInput = ref('');
            const urlStatus = ref(null);
            const autoFilledName = ref('');
            const newExpense = reactive({ id: null, item: '', amount: null, currency: 'TWD', targetAmount: null, targetCurrency: 'JPY', category: 'food', payer: 'Êàë', forWhom: ['Êàë'], date: new Date().toISOString().split('T')[0], paymentMethod: 'cash' });
            const editingExpenseId = ref(null);
            const newShopItem = ref('');
            const editingShopItem = ref(null);
            const tempShopImage = ref(null);
            const newInfo = reactive({ id: null, title: '', content: '', image: null });
            const editingInfoId = ref(null);
            const editingFlightType = ref('dep');
            const tempFlight = ref({});
            const weather = reactive({ temp: '--', icon: 'fa-solid fa-cloud', desc: 'ËºâÂÖ•‰∏≠...', rain: 0, loading: false, location: '', forecast: [] });
            const transText = ref('');
            const translations = reactive({ ja: '', en: '', ko: '' });
            const fullscreenText = ref('');
            let transTimeout = null;
            const newTravelerName = ref('');
            const calcInput = ref('');
            const calcCurrency = ref('JPY');
            const autoSaveStatus = ref(false);
            const fileInput = ref(null);
            const sortableList = ref(null);
            const suggestions = reactive({ list: [], type: '' });
            const summaryFilter = ref('all');
            const STORAGE_KEY = 'okinawa_go_v88_8_data';
            const categoryLabels = { food: 'È§êÈ£≤', traffic: '‰∫§ÈÄö', accommodation: '‰ΩèÂÆø', shopping: 'Ë≥ºÁâ©', entertainment: 'Â®õÊ®Ç', exchange: 'ÊèõÂåØ', other: 'ÂÖ∂‰ªñ' };
            const rateCountdown = ref(60);
            const lastRateUpdate = ref('');
            const currentImage = ref('');
            const currentActivityId = ref(null);

            const calcResult = computed(() => { if(!calcInput.value) return 0; return Math.round(parseFloat(calcInput.value) * (settings.rates[calcCurrency.value]||1)); });
            const computedDates = computed(() => {
                const arr = []; const s = new Date(settings.startDate); const days = Math.ceil(Math.abs(new Date(settings.endDate)-s)/86400000)+1; const weekdays = ['Êó•','‰∏Ä','‰∫å','‰∏â','Âõõ','‰∫î','ÂÖ≠'];
                const now = new Date().setHours(0,0,0,0);
                for(let i=0; i<days; i++) { 
                    const d = new Date(s); d.setDate(s.getDate()+i); 
                    const isToday = d.setHours(0,0,0,0) === now;
                    arr.push({ dayLabel: `DAY ${i+1}`, dateLabel: `${d.getMonth()+1}/${d.getDate()} (${weekdays[d.getDay()]})`, isToday }); 
                }
                return arr;
            });
            
            const isTodaySelected = computed(() => {
                if(selectedDayIdx.value < 0 || selectedDayIdx.value >= computedDates.value.length) return false;
                return computedDates.value[selectedDayIdx.value].isToday;
            });

            const currentItinerary = computed(() => {
                let items = [...(itineraryData.value[selectedDayIdx.value] || [])];
                if(selectedDayIdx.value === 0 && flights.dep.code) { items.push({isFlight:true, type:'dep', ...flights.dep, title:'ÂéªÁ®ãËà™Áè≠'}); }
                if(selectedDayIdx.value === computedDates.value.length-1 && flights.ret.code) { items.push({isFlight:true, type:'ret', ...flights.ret, title:'ÂõûÁ®ãËà™Áè≠'}); }
                return items.sort((a,b) => (a.time||'00:00').localeCompare(b.time||'00:00')).filter((v,i,a) => v && (v.id || v.code));
            });
            
            // New Function: Identify Current Activity
            const checkCurrentActivity = () => {
                // If the selected day is NOT today, do not highlight
                if (!isTodaySelected.value) {
                    currentActivityId.value = null;
                    return;
                }

                const now = new Date();
                const currentMinutes = now.getHours() * 60 + now.getMinutes();
                const items = currentItinerary.value;
                let activeId = null;

                // Find the item that started most recently
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (!item.time) continue;
                    
                    const [h, m] = item.time.split(':').map(Number);
                    const itemStartMinutes = h * 60 + m;

                    if (itemStartMinutes <= currentMinutes) {
                        activeId = item.id;
                    } else {
                        // Once we hit an item in the future, the previous one was the current one
                        break; 
                    }
                }
                currentActivityId.value = activeId;
            };

            const scrollToActive = () => {
                if(currentActivityId.value) {
                    nextTick(() => {
                        const el = document.getElementById(`item-${currentActivityId.value}`);
                        if(el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    });
                }
            };

            const calculatedRates = computed(() => {
                const rateMap = {};
                const accumulator = {};
                expenses.value.forEach(e => {
                    if (e.category === 'exchange' && e.payer === 'Êàë' && e.currency === 'TWD') {
                        const targetCurr = e.targetCurrency;
                        const costTwd = parseFloat(e.amount);
                        const targetAmount = parseFloat(e.targetAmount);
                        if (!accumulator[targetCurr]) accumulator[targetCurr] = { costTwd: 0, amount: 0 };
                        accumulator[targetCurr].costTwd += costTwd;
                        accumulator[targetCurr].amount += targetAmount;
                    }
                });
                Object.keys(accumulator).forEach(curr => {
                    const data = accumulator[curr];
                    if (data.amount > 0) rateMap[curr] = data.costTwd / data.amount;
                });
                return rateMap;
            });

            const getExpenseCostInTwd = (e) => {
                if (e.currency === 'TWD') return Math.round(parseFloat(e.amount));
                let cost = 0;
                if (e.paymentMethod === 'card') {
                    cost = parseFloat(e.amount) * (settings.rates[e.currency] || 1);
                } else if (e.paymentMethod === 'cash') {
                    const historicalRate = calculatedRates.value[e.currency];
                    if (historicalRate) cost = parseFloat(e.amount) * historicalRate;
                    else cost = parseFloat(e.amount) * (settings.rates[e.currency] || 1);
                } else {
                    cost = parseFloat(e.amount) * (settings.rates[e.currency] || 1);
                }
                return Math.round(cost);
            };

            const tripStats = computed(() => { 
                const myExpenses = expenses.value.filter(e => e.payer === 'Êàë' && e.category !== 'exchange');
                const spent = Math.round(myExpenses.reduce((s,e) => s + getExpenseCostInTwd(e), 0)); 
                return { spent, remaining: settings.budget-spent, percentage: settings.budget>0?(spent/settings.budget)*100:0 }; 
            });

            const walletHoldings = computed(() => {
                let balances = { 'TWD': { amount: settings.budget, rate: null } };
                expenses.value.forEach(e => {
                    if (e.payer !== 'Êàë') return;
                    const amt = parseFloat(e.amount);
                    if (e.category === 'exchange') {
                        if (!balances[e.currency]) balances[e.currency] = { amount: 0, rate: null };
                        balances[e.currency].amount -= amt;
                        const targetAmt = parseFloat(e.targetAmount || 0);
                        const targetCurr = e.targetCurrency || 'JPY';
                        if (!balances[targetCurr]) balances[targetCurr] = { amount: 0, rate: null };
                        balances[targetCurr].amount += targetAmt;
                    } else {
                        if (e.paymentMethod === 'cash') {
                            if (!balances[e.currency]) balances[e.currency] = { amount: 0, rate: null };
                            balances[e.currency].amount -= amt;
                        }
                    }
                });
                const result = {};
                Object.keys(balances).forEach(c => {
                    const avgRate = calculatedRates.value[c];
                    if (c === 'TWD' || Math.round(balances[c].amount) !== 0) {
                        result[c] = { amount: Math.round(balances[c].amount), rate: avgRate ? avgRate.toFixed(4) : null };
                    }
                });
                return result;
            });

            const publicFundStats = computed(() => {
                if (!settings.travelers.includes('ÂÖ¨Ë≤ª')) return null;
                const balances = {};
                expenses.value.forEach(e => {
                    if (e.category === 'exchange') return;
                    const currency = e.currency;
                    const amount = parseFloat(e.amount);
                    if (!balances[currency]) balances[currency] = 0;
                    if (e.payer !== 'ÂÖ¨Ë≤ª' && e.forWhom.includes('ÂÖ¨Ë≤ª')) {
                        const splitAmt = amount / e.forWhom.length;
                        balances[currency] += splitAmt;
                    }
                    if (e.payer === 'ÂÖ¨Ë≤ª') balances[currency] -= amount;
                });
                const result = {};
                Object.keys(balances).forEach(c => {
                    if (Math.round(balances[c]) !== 0) result[c] = Math.round(balances[c]);
                });
                return result;
            });

            const currentDayExpenses = computed(() => {
                if (selectedDayIdx.value === 'summary' || selectedDayIdx.value === 'dashboard') return [];
                let targetDate;
                if (selectedDayIdx.value === -1) {
                    const d = new Date(settings.startDate); d.setDate(d.getDate() - 1);
                    targetDate = d.toISOString().split('T')[0];
                } else {
                    targetDate = new Date(new Date(settings.startDate).getTime()+selectedDayIdx.value*86400000).toISOString().split('T')[0];
                }
                return expenses.value.filter(e => e.date === targetDate);
            });

            const dayTotalTwd = computed(() => {
                return currentDayExpenses.value.filter(e => e.payer === 'Êàë' && e.category !== 'exchange').reduce((s,e) => s + getExpenseCostInTwd(e), 0);
            });

            const tripTotalTwd = computed(() => tripStats.value.spent);
            
            const filteredSummaryExpenses = computed(() => { 
                let list = expenses.value.sort((a,b) => new Date(a.date) - new Date(b.date)); 
                if (summaryFilter.value !== 'all') list = list.filter(e => e.category === summaryFilter.value); 
                return list; 
            });
            
            const categories = computed(() => { 
                const c={food:0,traffic:0,accommodation:0,shopping:0,entertainment:0,exchange:0,other:0}; 
                expenses.value.filter(e => e.payer === 'Êàë' && e.category !== 'exchange').forEach(e => { c[e.category] += getExpenseCostInTwd(e) }); 
                return Object.entries(c).map(([k,v])=>({cat:k,amt:Math.round(v)})).filter(x=>x.amt>0).sort((a,b)=>b.amt-a.amt); 
            });

            const calculatedTransfers = computed(() => {
                // Feature: Smart Debt Simplification (Greedy algorithm based on Net Balances)
                // This automatically handles the A->B, B->C situation by cancelling out B's intermediate debt.
                const bal = {}; 
                const people = settings.travelers.filter(t => t !== 'ÂÖ¨Ë≤ª');
                people.forEach(t => bal[t] = 0);
                
                // Calculate Net Balance for everyone
                expenses.value.forEach(e => {
                    if (e.payer === 'ÂÖ¨Ë≤ª' || e.category === 'exchange') return; 
                    const amt = Math.round(getExpenseCostInTwd(e));
                    const validTargets = e.forWhom.filter(p => p !== 'ÂÖ¨Ë≤ª');
                    if (validTargets.length === 0) return;
                    const unitPrice = amt / e.forWhom.length;
                    
                    // Payer gets positive balance (creditor)
                    if (bal[e.payer] !== undefined) bal[e.payer] += (unitPrice * validTargets.length);
                    // Spenders get negative balance (debtor)
                    validTargets.forEach(p => { if (bal[p] !== undefined) bal[p] -= unitPrice; });
                });

                // Split into Debtors (negative) and Creditors (positive)
                const d=[], c=[]; 
                Object.entries(bal).forEach(([n,v])=>{
                    if(v < -1) d.push({n,v}); 
                    else if(v > 1) c.push({n,v})
                });
                
                // Sort by absolute value to minimize number of transactions (Greedy)
                d.sort((a,b)=>a.v-b.v); // Most negative first (e.g. -100, -50)
                c.sort((a,b)=>b.v-a.v); // Most positive first (e.g. 100, 50)
                
                const t=[]; 
                let i=0,j=0; 
                while(i<d.length && j<c.length){ 
                    // The amount to settle is the minimum of the debt or the credit
                    const amt = Math.min(Math.abs(d[i].v), c[j].v); 
                    if(amt > 0) t.push({from:d[i].n, to:c[j].n, amount:Math.round(amt)}); 
                    
                    d[i].v += amt; 
                    c[j].v -= amt; 
                    
                    if(Math.abs(d[i].v) < 1) i++; 
                    if(c[j].v < 1) j++; 
                } 
                return t;
            });

            const exportReport = () => {
                let csvContent = "\uFEFF"; 
                csvContent += "Êó•Êúü,È†ÖÁõÆ,ÂàÜÈ°û,ÂéüÂßãÈáëÈ°ç,Âπ£Âà•,ÊîØ‰ªòÊñπÂºè,‰º∞ÁÆóÂè∞Âπ£ÊàêÊú¨,ÂåØÁéá‰æÜÊ∫ê,‰ªòÊ¨æ‰∫∫,ÂàÜÊî§Â∞çË±°\n";
                expenses.value.forEach(e => {
                    const costTwd = e.category === 'exchange' ? '-' : Math.round(getExpenseCostInTwd(e));
                    let rateSource = '-';
                    if (e.category !== 'exchange') {
                        if (e.paymentMethod === 'card') rateSource = `Âç≥ÊôÇ (${settings.rates[e.currency]})`;
                        else if (e.paymentMethod === 'cash') {
                            const rate = calculatedRates.value[e.currency];
                            rateSource = rate ? `ÊåÅÊúâÊàêÊú¨ (${rate.toFixed(4)})` : `Âç≥ÊôÇ (${settings.rates[e.currency] || 1})`;
                        }
                    }
                    let row = [
                        e.date, `"${e.item.replace(/"/g, '""')}"`, categoryLabels[e.category] || e.category, e.amount, e.currency,
                        e.paymentMethod === 'card' ? 'Âà∑Âç°' : 'ÁèæÈáë', costTwd, rateSource, e.payer, `"${e.forWhom.join(',')}"`
                    ];
                    csvContent += row.join(",") + "\n";
                });
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `TravelGo_Report_${new Date().toISOString().slice(0,10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const saveToLocal = (s=true) => { localStorage.setItem(STORAGE_KEY, JSON.stringify({ settings, flights, itineraryData: itineraryData.value, expenses: expenses.value, todoList: todoList.value, shoppingList: shoppingList.value, infoList: infoList.value })); if(s){autoSaveStatus.value=true;setTimeout(()=>autoSaveStatus.value=false,2000);} };
            const loadFromLocal = () => {
                const d = JSON.parse(localStorage.getItem(STORAGE_KEY)); if(!d) { saveToLocal(false); return; }
                if(d.settings) Object.assign(settings, d.settings); if(d.flights) Object.assign(flights, d.flights);
                itineraryData.value=d.itineraryData||{}; expenses.value=d.expenses||[]; todoList.value=d.todoList||[]; shoppingList.value=d.shoppingList||[]; infoList.value=d.infoList||[];
                document.documentElement.style.setProperty('--theme-color', settings.color); nextTick(initSortable);
                if(!settings.travelers.includes(newExpense.payer)) { newExpense.payer=settings.travelers[0]; newExpense.forWhom=[...settings.travelers]; }
            };

            const switchView = (v) => { currentView.value=v; if(v==='itinerary') nextTick(initSortable); };
            const selectDay = (i) => { 
                selectedDayIdx.value=i; 
                nextTick(() => {
                    initSortable();
                    checkCurrentActivity();
                    // If switching to a day that is today, scroll to active item
                    if(isTodaySelected.value) scrollToActive();
                });
                if(i !== 'summary' && i !== 'dashboard') {
                    if (i === -1) {
                        const d = new Date(settings.startDate); d.setDate(d.getDate() - 1);
                        newExpense.date = d.toISOString().split('T')[0];
                    } else {
                        newExpense.date = new Date(new Date(settings.startDate).getTime()+i*86400000).toISOString().split('T')[0]; 
                    }
                }
            };
            const changeColor = (c) => { settings.color=c; document.documentElement.style.setProperty('--theme-color', c); };
            const openItemModal = (item=null) => { editingItem.value=item; form.value = item ? {...item, hour:item.time.split(':')[0], minute:item.time.split(':')[1]} : {id:null, hour:'10', minute:'00', location:'', category:'activity', cost:null, note:'', sourceUrl:'', image: null}; urlInput.value=item?item.sourceUrl||'':''; modals.item=true; };
            const editItem = (i) => openItemModal(i);
            const saveItem = () => { if(!form.value.location)return alert("Âú∞ÈªûÂøÖÂ°´"); form.value.time=`${form.value.hour}:${form.value.minute}`; const list=itineraryData.value[selectedDayIdx.value]||[]; if(editingItem.value) Object.assign(list.find(i=>i.id===form.value.id), form.value); else { if(!itineraryData.value[selectedDayIdx.value])itineraryData.value[selectedDayIdx.value]=[]; itineraryData.value[selectedDayIdx.value].push({...form.value, id:Date.now()}); } modals.item=false; saveToLocal(); nextTick(initSortable); checkCurrentActivity(); };
            const deleteItem = (id) => { if(confirm('Âà™Èô§?')) { itineraryData.value[selectedDayIdx.value]=itineraryData.value[selectedDayIdx.value].filter(i=>i.id!==id); saveToLocal(); checkCurrentActivity(); } };
            
            const copyItemToDay = (item) => {
                const dayStr = prompt(`Ë§áË£Ω "${item.location}" Âà∞Âì™‰∏ÄÂ§©? (Ë´ãËº∏ÂÖ• 1-${computedDates.value.length})`, selectedDayIdx.value + 1);
                if (!dayStr) return;
                const dayNum = parseInt(dayStr);
                if (isNaN(dayNum) || dayNum < 1 || dayNum > computedDates.value.length) {
                    alert('ÁÑ°ÊïàÁöÑÂ§©Êï∏');
                    return;
                }
                const targetIdx = dayNum - 1;
                if (!itineraryData.value[targetIdx]) itineraryData.value[targetIdx] = [];
                const newItem = JSON.parse(JSON.stringify(item));
                newItem.id = Date.now() + Math.random();
                itineraryData.value[targetIdx].push(newItem);
                itineraryData.value[targetIdx].sort((a,b) => (a.time||'00:00').localeCompare(b.time||'00:00'));
                saveToLocal();
                alert(`Â∑≤Ë§áË£ΩÂà∞ DAY ${dayNum}`);
            };
            
            const copyItinerary = () => { 
                let t = `„Äê${settings.title}„Äë\nüìÖ ${settings.startDate} ~ ${settings.endDate}\n\n`;
                computedDates.value.forEach((dateObj, idx) => {
                    t += `----------\n${dateObj.dayLabel} - ${dateObj.dateLabel}\n`;
                    let items = [...(itineraryData.value[idx] || [])];
                    if(idx === 0 && flights.dep.code) items.push({isFlight:true, ...flights.dep});
                    if(idx === computedDates.value.length-1 && flights.ret.code) items.push({isFlight:true, ...flights.ret});
                    items.sort((a,b) => (a.time||'00:00').localeCompare(b.time||'00:00'));
                    if(items.length === 0) t += `(ÁÑ°Ë°åÁ®ã)\n`;
                    else {items.forEach(i => {if(i.isFlight) t += `‚úàÔ∏è ${i.time} ${i.code||''} ${i.from||''}‚Üí${i.to||''}\n`; else {t += `üìç ${i.time} ${i.location}\n`;if(i.note) t+= `    üìù ${i.note}\n`;}});} t += `\n`;
                });
                navigator.clipboard.writeText(t).then(() => alert('ÂÆåÊï¥Ë°åÁ®ãÂ∑≤Ë§áË£ΩÔºÅ')); 
            };
            
            const importPackingList = () => { ["ÂÖåÊèõÂ§ñÂπ£","Ë≥ºË≤∑ÊóÖÈÅä‰øùÈö™","Ë≠∑ÁÖßÁ∞ΩË≠â","Á∂≤Âç°","ÂÖÖÈõªÂô®","Ë°£Áâ©","Ëó•ÂìÅ"].forEach(t=>todoList.value.push({id:Date.now()+Math.random(),text:t,done:false})); saveToLocal(); };

            const openFlightModal = (type, item=null) => { 
                editingFlightType.value = type; editingFlightItem.value = item;
                let f = (item && item.isFlight) ? item : (flights[type] || { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', date: '', arriveDate: '', depTz: 8, arriveTz: 8 });
                tempFlight.value={ ...f, hour: (f.time||'10:00').split(':')[0], minute: (f.time||'10:00').split(':')[1], arriveHour: (f.arriveTime||'12:30').split(':')[0], arriveMinute: (f.arriveTime||'12:30').split(':')[1], extra: [] }; modals.flight=true; 
            };
            const addFlightToDay = () => { editingFlightItem.value = null; editingFlightType.value = 'day_item'; const d = new Date(settings.startDate); d.setDate(d.getDate() + selectedDayIdx.value); tempFlight.value = { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', date: d.toISOString().split('T')[0], arriveDate: d.toISOString().split('T')[0], depTz: 8, arriveTz: 8, hour: '10', minute: '00', arriveHour: '12', arriveMinute: '30', extra: [] }; modals.flight = true; };
            const saveFlight = () => { const fmt=(t)=>`${t.hour}:${t.minute}`, fmtA=(t)=>`${t.arriveHour}:${t.arriveMinute}`; tempFlight.value.time=fmt(tempFlight.value); tempFlight.value.arriveTime=fmtA(tempFlight.value); if (editingFlightType.value === 'dep' || editingFlightType.value === 'ret') { Object.assign(flights[editingFlightType.value], tempFlight.value); } else { const flightData = { ...tempFlight.value, isFlight: true, title: 'Ëà™Áè≠', type: 'day_item' }; if (editingFlightItem.value) { Object.assign(editingFlightItem.value, flightData); } else { if(!itineraryData.value[selectedDayIdx.value]) itineraryData.value[selectedDayIdx.value] = []; itineraryData.value[selectedDayIdx.value].push({ ...flightData, id: Date.now() }); } } modals.flight=false; saveToLocal(); };
            const removeFlightItem = () => { if (confirm("Á¢∫ÂÆöÁßªÈô§?")) { if (editingFlightItem.value) { itineraryData.value[selectedDayIdx.value] = itineraryData.value[selectedDayIdx.value].filter(i => i.id !== editingFlightItem.value.id); } modals.flight = false; saveToLocal(); } };
            const searchAirport = (q, t) => { if(!q||q.length<1){suggestions.list=[];return;} const k=q.toUpperCase(); suggestions.type=t; suggestions.list=airports.filter(a=>a.code.includes(k)||a.city.toUpperCase().includes(k)||a.cityZh.includes(k)).slice(0,5); };
            const selectAirport = (s, t, extraObj=null) => { const target = extraObj || tempFlight.value; if(t==='dep') { target.from=s.code; target.depTz=s.tz; } else if(t==='arr') { target.to=s.code; target.arriveTz=s.tz; } suggestions.list=[]; };
            const getFlightDuration = (i) => { if(!i.date||!i.arriveDate)return'--'; const d=new Date(i.arriveDate+'T'+i.arriveTime)-new Date(i.date+'T'+i.time)-((i.arriveTz-i.depTz)*3600000); if(d<0)return'ÈåØË™§'; return `${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`; };
            const isNextDay = (i) => i.date&&i.arriveDate && new Date(i.arriveDate)>new Date(i.date);
            const getDayDiff = (i) => Math.round((new Date(i.arriveDate)-new Date(i.date))/86400000);

            const resetExpense = () => { editingExpenseId.value=null; Object.assign(newExpense, {id:null, item:'', amount:null, currency:'TWD', targetAmount: null, targetCurrency: 'JPY', category:'food', payer:settings.travelers[0], forWhom:[...settings.travelers], paymentMethod: 'cash'}); selectDay(selectedDayIdx.value); }; 
            const openExpenseModal = (e = null) => {
                if (e) {
                      editingExpenseId.value = e.id;
                      Object.assign(newExpense, JSON.parse(JSON.stringify(e)));
                      if (!newExpense.paymentMethod) newExpense.paymentMethod = 'cash';
                } else {
                    resetExpense();
                }
                modals.expense = true;
            };
            const saveExpense = () => { if(!newExpense.item||!newExpense.amount)return alert('Ë´ãÂ°´ÂØ´ÂÆåÊï¥'); const d={...newExpense, amount:parseFloat(newExpense.amount)}; if(editingExpenseId.value) expenses.value[expenses.value.findIndex(e=>e.id===editingExpenseId.value)]=d; else {d.id=Date.now(); expenses.value.unshift(d);} resetExpense(); modals.expense=false; saveToLocal(); };
            
            const deleteExpense = (id) => { if(confirm('Âà™Èô§?')) { expenses.value=expenses.value.filter(e=>e.id!==id); saveToLocal(); } };
            const toggleSplit = (p) => { const i=newExpense.forWhom.indexOf(p); i>-1?newExpense.forWhom.splice(i,1):newExpense.forWhom.push(p); };
            
            const addTodo = () => { todoList.value.push({id:Date.now(), text:'', done:false}); saveToLocal(); };
            const deleteTodo = (id) => { todoList.value=todoList.value.filter(t=>t.id!==id); saveToLocal(); };
            
            const openShopModal = (item = null) => {
                if(item){ editingShopItem.value = item.id; newShopItem.value = item.text; tempShopImage.value = item.image; }
                else { editingShopItem.value = null; newShopItem.value = ''; tempShopImage.value = null; }
                modals.shopping = true;
            };
            const saveShopItem = () => { 
                if(!newShopItem.value) return;
                if(editingShopItem.value) {
                    const idx = shoppingList.value.findIndex(i => i.id === editingShopItem.value);
                    if(idx !== -1) {
                        shoppingList.value[idx].text = newShopItem.value;
                        shoppingList.value[idx].image = tempShopImage.value;
                    }
                } else {
                    shoppingList.value.push({id:Date.now(), text:newShopItem.value, done:false, image: tempShopImage.value}); 
                }
                newShopItem.value=''; tempShopImage.value=null; modals.shopping=false; saveToLocal();
            };
            const deleteShopItem = (id) => { shoppingList.value=shoppingList.value.filter(i=>i.id!==id); saveToLocal(); };
            
            const openInfoModal = () => { editingInfoId.value = null; newInfo.title = ''; newInfo.content = ''; newInfo.image = null; modals.info = true; };
            const saveInfo = () => { 
                if(!newInfo.title) return;
                const d = { ...newInfo, id: editingInfoId.value || Date.now() }; 
                if(editingInfoId.value) {
                    const idx = infoList.value.findIndex(i => i.id === editingInfoId.value);
                    if (idx !== -1) infoList.value[idx] = d;
                } else {
                    infoList.value.unshift(d);
                }
                editingInfoId.value = null; newInfo.title = ''; newInfo.content = ''; newInfo.image = null; modals.info = false; saveToLocal(); 
            };
            
            const editInfo = (i) => { editingInfoId.value=i.id; newInfo.title=i.title; newInfo.content=i.content; newInfo.image=i.image; modals.info=true; };
            const deleteInfo = (id) => { if(confirm('Âà™Èô§?')){infoList.value=infoList.value.filter(i=>i.id!==id); saveToLocal();} };
            
            const togglePublicFund = () => {
                const idx = settings.travelers.indexOf('ÂÖ¨Ë≤ª');
                if (idx > -1) {
                    if(confirm('Á¢∫ÂÆöÁßªÈô§ÂÖ¨Ë≤ªÂ∏≥Êà∂ÔºüÁõ∏ÈóúË®òÂ∏≥Ë≥áÊñô‰ªçÊúÉ‰øùÁïô‰ΩÜË®àÁÆóÂèØËÉΩÂèóÂΩ±Èüø„ÄÇ')) {
                        settings.travelers.splice(idx, 1);
                        saveToLocal();
                    }
                } else {
                    settings.travelers.push('ÂÖ¨Ë≤ª');
                    saveToLocal();
                }
            };
            
            const addTraveler = () => { if(newTravelerName.value&&!settings.travelers.includes(newTravelerName.value)){settings.travelers.push(newTravelerName.value); newTravelerName.value=''; saveToLocal();} };
            const removeTraveler = (i) => { if(settings.travelers.length>1&&confirm('ÁßªÈô§?')){settings.travelers.splice(i,1); saveToLocal();} };

            const initSortable = () => { if(sortableList.value && currentView.value==='itinerary' && selectedDayIdx.value > -1 && selectedDayIdx.value !== 'summary' && selectedDayIdx.value !== 'dashboard'){ if(sortableList.value.sortable)sortableList.value.sortable.destroy(); sortableList.value.sortable=Sortable.create(sortableList.value, {animation:150, handle:'.handle', filter:'.flight-card', onUpdate:e=>{const l=itineraryData.value[selectedDayIdx.value]; l.splice(e.newIndex,0,l.splice(e.oldIndex,1)[0]); saveToLocal();}}); } };
            const getCategoryColor = (c) => ({travel:'border-l-blue-400', food:'border-l-red-400', accommodation:'border-l-green-400', activity:'border-l-yellow-400', shopping:'border-l-purple-400', other:'border-l-gray-400'}[c]||'border-l-gray-400');
            const getCategoryIcon = (c) => ({travel:'fa-solid fa-plane-departure', food:'fa-solid fa-utensils', accommodation:'fa-solid fa-bed', activity:'fa-solid fa-person-running', shopping:'fa-solid fa-bag-shopping', other:'fa-solid fa-lightbulb'}[c]||'fa-solid fa-lightbulb');
            const getCategoryHex = (c) => ({food:'#F87171', traffic:'#60A5FA', accommodation:'#34D399', shopping:'#A78BFA', entertainment:'#FBBF24', exchange: '#93C5FD', other:'#9CA3AF'}[c]||'#9CA3AF');
            const getCategoryLabel = (c) => categoryLabels[c] || 'ÂÖ∂‰ªñ';
            const getNavUrl = (i) => i.sourceUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location)}`;
            const getBudgetColorClass = () => { const p=tripStats.value.percentage; return p<50?'text-green-500':p<80?'text-yellow-600':p<100?'text-orange-500':'text-red-500'; };
            const getBudgetBgClass = () => { const p=tripStats.value.percentage; return p<50?'bg-green-500':p<80?'bg-yellow-500':p<100?'bg-orange-500':'bg-red-500'; };
            
            const getWeatherIcon = (code) => {
                if(code <= 3) return 'fa-solid fa-sun';
                if(code >= 95) return 'fa-solid fa-cloud-bolt';
                if(code >= 71) return 'fa-regular fa-snowflake';
                return 'fa-solid fa-cloud-rain';
            };

            const fetchWeather = async () => { 
                weather.loading=true; 
                navigator.geolocation.getCurrentPosition(
                    async p => { 
                        try {
                            const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,precipitation_probability_max&timezone=auto&forecast_days=5`);
                            const d = await r.json();
                            weather.temp = Math.round(d.current_weather.temperature);
                            weather.icon = getWeatherIcon(d.current_weather.weathercode);
                            weather.desc = d.current_weather.weathercode <= 3 ? 'Êô¥/Â§öÈõ≤' : 'Èõ®Â§©';
                            weather.rain = d.daily.precipitation_probability_max[0];
                            weather.forecast = [];
                            const weekdays = ['ÈÄ±Êó•','ÈÄ±‰∏Ä','ÈÄ±‰∫å','ÈÄ±‰∏â','ÈÄ±Âõõ','ÈÄ±‰∫î','ÈÄ±ÂÖ≠'];
                            if(d.daily && d.daily.time && d.daily.time.length >= 5) {
                                for(let i=1; i<=4; i++) {
                                    let label = '';
                                    if(i === 1) label = 'ÊòéÂ§©';
                                    else if(i === 2) label = 'ÂæåÂ§©';
                                    else {
                                        const date = new Date();
                                        date.setDate(date.getDate() + i);
                                        label = weekdays[date.getDay()];
                                    }
                                    weather.forecast.push({
                                        label: label,
                                        min: Math.round(d.daily.temperature_2m_min[i]),
                                        max: Math.round(d.daily.temperature_2m_max[i]),
                                        code: d.daily.weathercode[i],
                                        rain: d.daily.precipitation_probability_max[i]
                                    });
                                }
                            }
                            const rl = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&accept-language=zh-TW`);
                            const dl = await rl.json();
                            weather.location = dl.address.city || dl.address.town || 'ÁõÆÂâç‰ΩçÁΩÆ';
                        } catch(e) { weather.desc='Â§±Êïó'; console.error(e); }
                        weather.loading=false; 
                    }, 
                    error => { weather.loading = false; weather.desc = 'ÂÆö‰ΩçÂ§±Êïó'; alert('ÁÑ°Ê≥ïÁç≤Âèñ‰ΩçÁΩÆ„ÄÇ'); }
                ); 
            };
            
            const manualUpdateRates = async () => { await updateRates(false); rateCountdown.value = 60; };
            
            const updateRates = async (silent = false) => { 
                try {
                    const r = await fetch('https://open.er-api.com/v6/latest/TWD?_=' + Date.now());
                    const d = await r.json();
                    if(d.result === 'success') {
                        const newRates = { ...settings.rates };
                        Object.keys(newRates).forEach(c => {
                            if(d.rates[c]) {
                                const val = 1 / d.rates[c];
                                newRates[c] = +val.toFixed(6);
                            }
                        });
                        settings.rates = newRates;
                        const now = new Date();
                        lastRateUpdate.value = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
                        if(!silent) alert('Êõ¥Êñ∞ÊàêÂäü');
                        saveToLocal(!silent);
                    }
                } catch(e) { if(!silent) alert('Â§±Êïó: Ë´ãÊ™¢Êü•Á∂≤Ë∑Ø'); } 
            };
            
            const parseUrl = async () => { if(!urlInput.value)return; form.value.sourceUrl=urlInput.value; const m=urlInput.value.match(/center=(-?\d+\.\d+)%2C(-?\d+\.\d+)/); if(m){const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${m[1]}&lon=${m[2]}&accept-language=zh-TW`);const d=await r.json();if(d.name)autoFilledName.value=d.name;} urlStatus.value='success'; };
            
            const translate = async () => { 
                if(!transText.value||transText.value.length<1)return; 
                const cleanText = transText.value.replace(/<[^>]*>?/gm, '');
                try {
                    const fetchTrans = async (target) => {
                        const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=${target}&dt=t&q=${encodeURIComponent(cleanText)}`;
                        const res = await fetch(url);
                        const data = await res.json();
                        return data[0].map(s => s[0]).join('');
                    };
                    translations.ja = await fetchTrans('ja');
                    translations.en = await fetchTrans('en');
                    translations.ko = await fetchTrans('ko');
                } catch(e) { translations.en = "ÁøªË≠ØÂ§±Êïó (ÂèØËÉΩË¢´ÈòªÊìãÔºåË´ãÁ®çÂæåÂÜçË©¶)"; } 
            };
            const debouncedTranslate = () => { clearTimeout(transTimeout); transTimeout=setTimeout(translate,500); };
            const speak = (t, l) => { window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(t); u.lang = l; u.volume = 1; u.rate = 1; window.speechSynthesis.speak(u); };
            
            const compressImage = (file) => {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const maxWidth = 800; 
                            let width = img.width;
                            let height = img.height;
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                            canvas.width = width; canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleImageUpload = async (e, targetObj, type) => {
                const file = e.target.files[0];
                if (!file) return;
                const base64 = await compressImage(file);
                if (type === 'shop') { tempShopImage.value = base64; } else { targetObj.image = base64; }
            };

            const openImageModal = (imgSrc) => { currentImage.value = imgSrc; modals.image = true; };
            const triggerImport = () => { if(fileInput.value) fileInput.value.click(); };
            const handleImport = (e) => { const r=new FileReader(); r.onload=ev=>{const d=JSON.parse(ev.target.result);Object.assign(settings,d.settings);Object.assign(flights,d.flights);itineraryData.value=d.itineraryData;expenses.value=d.expenses;todoList.value=d.todoList;shoppingList.value=d.shoppingList;infoList.value=d.infoList;saveToLocal(false);location.reload();}; r.readAsText(e.target.files[0]); };
            const exportData = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({settings,flights,itineraryData:itineraryData.value,expenses:expenses.value,todoList:todoList.value,shoppingList:shoppingList.value,infoList:infoList.value})],{type:"application/json"})); a.download='backup.json'; a.click(); };
            const resetData = () => { 
                if(confirm('Á¢∫ÂÆöÈáçÁΩÆÊâÄÊúâË≥áÊñôÔºü')) { 
                    localStorage.removeItem(STORAGE_KEY);
                    Object.assign(settings, { title: 'Travel Go!!!', startDate: new Date().toISOString().split('T')[0], endDate: new Date(Date.now()+3*86400000).toISOString().split('T')[0], rates: { JPY: 0.22, KRW: 0.024, USD: 32, TWD: 1 }, color: '#60A5FA', budget: 0, travelers: ['Êàë'] });
                    Object.assign(flights, { dep: { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 }, ret: { code: '', bookingRef: '', ticketNo: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 } });
                    itineraryData.value = {}; expenses.value = []; todoList.value = []; shoppingList.value = []; infoList.value = [];
                    changeColor('#60A5FA');
                    alert("Ë≥áÊñôÂ∑≤ÈáçÁΩÆ");
                } 
            };
            
            const openFullscreen = (t) => { fullscreenText.value=t; modals.fullscreen=true; };
            const planRouteFromPrev = (i,idx) => { const p=currentItinerary.value[idx-1]; if(p) window.open(`https://www.google.com/maps/dir/${encodeURIComponent(p.isFlight?p.to:p.location)}/${encodeURIComponent(i.location)}`); };
            const editBudget = () => { modals.budget=false; saveToLocal(); };
            const generateDayRoute = () => { const pts=currentItinerary.value.filter(i=>i.location||i.to).map(i=>i.isFlight?i.to:i.location); if(pts.length>1) window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(pts[0])}&destination=${encodeURIComponent(pts[pts.length-1])}&waypoints=${pts.slice(1,-1).map(p=>encodeURIComponent(p)).join('|')}`); };

            watch(settings, ()=>saveToLocal(), {deep:true}); watch(flights, ()=>saveToLocal(), {deep:true});
            onMounted(() => { 
                loadFromLocal(); 
                fetchWeather(); 
                const mask = document.getElementById('loading-mask'); if(mask) mask.style.display = 'none';
                setInterval(() => { rateCountdown.value--; if(rateCountdown.value <= 0) { rateCountdown.value = 60; updateRates(true); } }, 1000);
                setInterval(() => { checkCurrentActivity(); }, 30000); // Check every 30s
                updateRates(true);
                
                // Auto switch to Today
                setTimeout(() => {
                    const todayIdx = computedDates.value.findIndex(d => d.isToday);
                    if(todayIdx !== -1) {
                        selectDay(todayIdx);
                        setTimeout(scrollToActive, 500); // Wait for sortable/render
                    }
                }, 500);
            });

            return { 
                settings, computedDates, currentItinerary, currentView, selectedDayIdx, form, editingItem, editingFlightItem, urlInput, urlStatus, autoFilledName, itineraryData, expenses, todoList, shoppingList, infoList, newExpense, newShopItem, newInfo, transText, translations, fullscreenText, flights, tempFlight, editingFlightType, dayTotalTwd, categories, tripTotalTwd, tripStats, switchView, selectDay, changeColor, openItemModal, editItem, saveItem, deleteItem, saveExpense, openExpenseModal, deleteExpense, addTodo, deleteTodo, openShopModal, saveShopItem, deleteShopItem, saveInfo, editInfo, deleteInfo, openInfoModal, editingInfoId, parseUrl, getCategoryColor, getCategoryIcon, getNavUrl, getCategoryLabel, getCategoryHex, openFlightModal, saveFlight, addFlightToDay, removeFlightItem, openFullscreen, debouncedTranslate, speak, sortableList, updateRates, manualUpdateRates, exportData, resetData, weather, fetchWeather, calcInput, calcResult, calcCurrency, modals, autoSaveStatus, fileInput, triggerImport, handleImport, addTraveler, removeTraveler, newTravelerName, calculatedTransfers, toggleSplit, editBudget, getBudgetColorClass, getBudgetBgClass, generateDayRoute, copyItinerary, importPackingList, planRouteFromPrev, getFlightDuration, isNextDay, getDayDiff, suggestions, searchAirport, selectAirport, isPickingLocation: ref(false),
                currentDayExpenses, filteredSummaryExpenses, summaryFilter, categoryLabels, copyItemToDay, rateCountdown, editingExpenseId, editingShopItem, lastRateUpdate,
                handleImageUpload, openImageModal, currentImage, tempShopImage,
                publicFundStats, togglePublicFund, walletHoldings,
                exportReport, getExpenseCostInTwd, getWeatherIcon,
                currentActivityId, scrollToActive, isTodaySelected
            };
        }
    });
    
    app.mount('#app');
</script>
</body>
</html>

