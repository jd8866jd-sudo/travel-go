<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#60A5FA">
    <title>Travel Go!!!</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§³</text></svg>">
    <link rel="manifest" href="manifest.json">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        window.onerror = function(msg, url, line) {
            if(msg.includes('ResizeObserver')) return false;
            const errDiv = document.getElementById('error-display');
            if(errDiv) { errDiv.style.display = 'block'; errDiv.innerText += `éŒ¯èª¤: ${msg}\nè¡Œæ•¸: ${line}\n`; }
            return false;
        };
    </script>

    <style>
        :root { --theme-color: #60A5FA; }
        body { font-family: 'Zen Maru Gothic', sans-serif; background-color: #222; color: #4A4A4A; margin: 0; display: flex; justify-content: center; min-height: 100vh; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        
        #app { 
            background-color: #F0F9FF; width: 100%; max-width: 480px; height: 100vh; height: 100dvh; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            /* èƒŒæ™¯ï¼šåŸå§‹é»‘æŸ´é ­åƒ + æ”¾å¤§æŒå° */
            background-image: url("data:image/svg+xml,%3Csvg width='240' height='240' viewBox='0 0 240 240' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000' opacity='0.06'%3E%3Cpath transform='scale(1.2) translate(-10, -10)' d='M40 40c-3 0-5-3-5-6s2-6 5-6 5 3 5 6-2 6-5 6zm-8-2c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm16 0c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm-8 10c4 0 7-3 8-6 0-4-3-8-8-8s-8 4-8 8c1 3 4 6 8 6z'/%3E%3Cpath transform='translate(160, 20) scale(1.1)' d='M40 40c-3 0-5-3-5-6s2-6 5-6 5 3 5 6-2 6-5 6zm-8-2c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm16 0c-2 0-3-2-3-4s1-4 3-4 3 2 3 4-1 4-3 4zm-8 10c4 0 7-3 8-6 0-4-3-8-8-8s-8 4-8 8c1 3 4 6 8 6z'/%3E%3C/g%3E%3Cg transform='translate(130, 130) scale(1.8)' opacity='0.12'%3E%3Cpath d='M10 15 Q25 5 40 15 Q48 25 45 35 Q42 45 25 45 Q8 45 5 35 Q2 25 10 15 L8 2 L18 10 M32 10 L42 2 L38 15' fill='%232B2B2B' stroke='%232B2B2B' stroke-width='2' stroke-linejoin='round'/%3E%3Cpath d='M11 11 L9 4 L16 9 Z' fill='%23E4B886'/%3E%3Cpath d='M39 11 L41 4 L34 9 Z' fill='%23E4B886'/%3E%3Cpath d='M5 28 Q15 22 25 28 Q35 22 45 28 Q46 38 40 42 Q25 48 10 42 Q4 38 5 28' fill='white'/%3E%3Cellipse cx='16' cy='18' rx='2.5' ry='1.5' fill='%23E4B886'/%3E%3Cellipse cx='34' cy='18' rx='2.5' ry='1.5' fill='%23E4B886'/%3E%3Ccircle cx='18' cy='24' r='2' fill='black'/%3E%3Ccircle cx='32' cy='24' r='2' fill='black'/%3E%3Cellipse cx='25' cy='30' rx='2.5' ry='2' fill='black'/%3E%3Cpath d='M25 32 L25 34' stroke='black' stroke-width='0.5'/%3E%3Cpath d='M22 34 Q25 37 28 34' fill='none' stroke='black' stroke-width='1'/%3E%3Ccircle cx='10' cy='32' r='2' fill='%23FFAB91' opacity='0.5'/%3E%3Ccircle cx='40' cy='32' r='2' fill='%23FFAB91' opacity='0.5'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        .theme-bg { background-color: var(--theme-color) !important; color: white !important; transition: background-color 0.2s; }
        .theme-text { color: var(--theme-color) !important; transition: color 0.2s; }
        .theme-border { border-color: var(--theme-color) !important; transition: border-color 0.2s; }
        .theme-ring:focus { --tw-ring-color: var(--theme-color) !important; ring-color: var(--theme-color) !important; box-shadow: 0 0 0 2px var(--theme-color) !important; }
        .date-active { background-color: var(--theme-color) !important; color: white !important; border-color: var(--theme-color) !important; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .flight-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 2px dashed var(--theme-color); position: relative; overflow: hidden; cursor: pointer; transition: all 0.2s; margin-bottom: 0.75rem; }
        .flight-card:hover { opacity: 0.95; transform: scale(0.99); }
        .flight-card::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background-color: var(--theme-color); }
        .watermark { position: absolute; top: 40px; left: 0; right: 0; text-align: center; font-size: 10px; font-weight: bold; color: #aaa; opacity: 0.5; pointer-events: none; z-index: 1; letter-spacing: 1px; user-select: none; }
        .bottom-nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9CA3AF; transition: all 0.2s; font-size: 10px; font-weight: bold; }
        .bottom-nav-item.active { color: var(--theme-color); transform: translateY(-2px); }
        .bottom-nav-item i { font-size: 20px; margin-bottom: 2px; }
        .fab-calc { position: absolute; bottom: 80px; right: 20px; width: 50px; height: 50px; border-radius: 50%; background-color: white; color: var(--theme-color); box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; z-index: 40; border: 2px solid var(--theme-color); font-size: 20px; transition: transform 0.2s; }
        .fab-calc:active { transform: scale(0.9); }
        .member-pill { transition: all 0.2s; border: 1px solid transparent; }
        .member-pill.active { background-color: var(--theme-color); color: white; border-color: var(--theme-color); }
        .member-pill.inactive { background-color: #f3f4f6; color: #9ca3af; border-color: #e5e7eb; }
        .suggestion-list { position: absolute; background: white; width: 100%; max-height: 150px; overflow-y: auto; border: 1px solid #eee; border-radius: 0 0 8px 8px; z-index: 60; box-shadow: 0 4px 6px rgba(0,0,0,0.1); left: 0; top: 100%; }
        .suggestion-item { padding: 8px 12px; font-size: 12px; border-bottom: 1px solid #f0f0f0; cursor: pointer; display: flex; justify-content: space-between; }
        .suggestion-item:hover { background-color: #f9fafb; }
        #loading-mask { position: fixed; inset: 0; background: #F0F9FF; z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        #error-display { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); color: white; padding: 20px; z-index: 10000; overflow: auto; white-space: pre-wrap; font-family: monospace; }
    </style>
</head>
<body>

<div id="error-display"></div>
<div id="loading-mask">
    <i class="fa-solid fa-plane fa-bounce text-4xl text-blue-400 mb-4"></i>
    <div class="text-gray-500 font-bold">è¼‰å…¥ä¸­...</div>
</div>

<div id="app">
    <div class="watermark">CopyrightÂ© 2025 Eugenie Teng</div>

    <header v-if="!isPickingLocation" class="px-6 pt-8 pb-2 z-20 bg-transparent">
        <div class="flex justify-between items-center mb-4">
            <div class="flex-1 mr-3">
                <h1 class="text-2xl font-bold theme-text tracking-wide truncate">{{ settings.title }}</h1>
                <p class="text-[10px] text-gray-400 tracking-wider">V88.8 æœ€çµ‚å®Œç¾ç‰ˆ <span v-if="autoSaveStatus" class="ml-1 text-green-500"><i class="fa-solid fa-check"></i> å·²åŒæ­¥</span></p>
            </div>
            <!-- æŒ‰éˆ•å€ï¼šè¨ˆç®—æ©Ÿç§»è‡³è¨­å®šå·¦å´ -->
            <div class="flex gap-2">
                <button @click="modals.calc = true" class="w-10 h-10 rounded-xl bg-white text-gray-400 shadow-sm flex items-center justify-center hover:bg-gray-50"><i class="fa-solid fa-calculator"></i></button>
                <button @click="modals.settings = true" class="w-10 h-10 rounded-xl bg-white text-gray-400 shadow-sm flex items-center justify-center hover:bg-gray-50"><i class="fa-solid fa-gear"></i></button>
            </div>
        </div>

        <div v-if="['itinerary', 'wallet'].includes(currentView)" class="flex space-x-3 overflow-x-auto hide-scrollbar pb-2">
            <div @click="selectDay(-1)" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === -1 }">
                <span class="text-xs font-bold">PRE</span><i class="fa-solid fa-clipboard-check mt-1"></i>
            </div>
            <div v-for="(dateObj, index) in computedDates" :key="index" @click="selectDay(index)"
                class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm"
                :class="{ 'date-active': selectedDayIdx === index }">
                <span class="text-xs font-bold">{{ dateObj.dayLabel }}</span>
                <span class="text-[10px] font-medium whitespace-nowrap">{{ dateObj.dateLabel }}</span>
            </div>
            <!-- ç¸½çµé ç±¤ (åƒ…åœ¨è¨˜å¸³ä»‹é¢é¡¯ç¤º) -->
            <div v-if="currentView === 'wallet'" @click="selectDay('summary')" class="flex-shrink-0 flex flex-col items-center justify-center w-16 h-16 rounded-2xl transition-all cursor-pointer border border-white bg-white text-gray-400 shadow-sm" :class="{ 'date-active': selectedDayIdx === 'summary' }">
                <span class="text-xs font-bold">ç¸½çµ</span><i class="fa-solid fa-chart-pie mt-1"></i>
            </div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto hide-scrollbar relative px-5 pb-8 flex flex-col z-10">
        <!-- Itinerary -->
        <div v-if="currentView === 'itinerary'" class="pb-20">
            <div v-if="selectedDayIdx === -1">
                <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold theme-text">è¡Œå‰æº–å‚™</h2><button @click="importPackingList" class="text-xs theme-bg text-white px-3 py-1.5 rounded-full shadow-sm">ğŸ“¥ åŒ¯å…¥æ¸…å–®</button></div>
                <div class="space-y-3">
                    <div v-for="todo in todoList" :key="todo.id" class="flex items-center bg-white p-4 rounded-2xl shadow-sm"><input type="checkbox" v-model="todo.done" class="w-5 h-5 theme-text rounded focus:ring-0 cursor-pointer"><input v-model="todo.text" class="ml-3 flex-1 outline-none text-sm text-gray-700" :class="{'line-through text-gray-300': todo.done}"><button @click="deleteTodo(todo.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button></div>
                    <button @click="addTodo" class="w-full py-3 rounded-2xl border-2 border-dashed border-gray-300 text-gray-400 text-sm hover:border-gray-400 transition"><i class="fa-solid fa-plus mr-1"></i> æ–°å¢å¾…è¾¦</button>
                </div>
            </div>
            <div v-else>
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-dark">è¡Œç¨‹å®‰æ’</h2>
                    <div class="flex space-x-2">
                         <button @click="generateDayRoute" class="bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-blue-200"><i class="fa-solid fa-map-location-dot mr-1"></i> ç¸½è¦½</button>
                         <button @click="copyItinerary" class="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-gray-200"><i class="fa-regular fa-copy mr-1"></i> è¤‡è£½</button>
                         <button @click="addFlightToDay" class="bg-purple-100 text-purple-600 px-3 py-1.5 rounded-full text-[10px] font-bold shadow-sm hover:bg-purple-200"><i class="fa-solid fa-plane mr-1"></i> èˆªç­</button>
                         <button @click="openItemModal()" class="theme-bg text-white w-8 h-8 rounded-full shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-plus text-lg"></i></button>
                    </div>
                </div>
                <div ref="sortableList" class="space-y-3 pb-10 min-h-[100px]">
                    <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-map-location text-4xl mb-3"></i><p>é»æ“Šå³ä¸Šæ–¹ + æ–°å¢è¡Œç¨‹</p></div>
                    <div v-for="(item, index) in currentItinerary" :key="item.id || item.code" :data-id="item.id">
                        <div v-if="item.isFlight" @click="openFlightModal(item.type, item)" class="flight-card">
                            <div class="flex justify-between text-xs text-gray-400 font-bold mb-1"><span>{{ item.title }}</span><span>{{ item.from }} <i class="fa-solid fa-plane mx-1"></i> {{ item.to }}</span></div>
                            <div class="flex justify-between items-end">
                                <div class="text-3xl font-bold theme-text">{{ item.time }}</div>
                                <div class="flex flex-col items-center justify-center w-full px-2">
                                    <div v-if="isNextDay(item)" class="text-[10px] text-red-500 font-bold mb-0.5">+{{ getDayDiff(item) }}æ—¥</div>
                                    <div class="text-[10px] font-bold theme-text mb-1 bg-blue-50 px-2 py-0.5 rounded-full"><i class="fa-regular fa-clock mr-1"></i>{{ getFlightDuration(item) }}</div>
                                    <div class="text-2xl font-bold text-gray-600">{{ item.code }}</div>
                                </div>
                                <div class="text-3xl font-bold theme-text">{{ item.arriveTime }}</div>
                            </div>
                            <div class="mt-1 text-xs text-gray-400 font-bold text-center border-t border-gray-100 pt-1">{{ item.airline || 'èˆªç©ºå…¬å¸' }}</div>
                        </div>
                        <div v-else class="bg-white rounded-[24px] p-4 shadow-sm relative group border-l-4 transition hover:shadow-md" :class="getCategoryColor(item.category)">
                            <div class="absolute right-4 top-4 text-gray-300 cursor-grab handle"><i class="fa-solid fa-grip-lines"></i></div>
                            <div class="flex items-start">
                                <div class="mr-3 pt-1 flex flex-col items-center w-14 text-center"><div class="bg-gray-100 text-gray-600 text-[12px] font-bold px-2 py-1 rounded-lg mb-2 font-mono">{{ item.time }}</div><i :class="[getCategoryIcon(item.category), 'text-xl text-gray-400']"></i></div>
                                <div class="flex-1 pr-6"><h3 class="font-bold text-gray-700 text-lg leading-tight mb-1">{{ item.location }}</h3><p class="text-xs text-gray-400 line-clamp-2 mb-2">{{ item.note }}</p>
                                    <div class="flex flex-wrap gap-2 mt-2">
                                        <button @click="editItem(item)" class="text-[10px] bg-gray-100 text-gray-500 px-3 py-1.5 rounded-full hover:bg-gray-200">ç·¨è¼¯</button>
                                        <button @click="deleteItem(item.id)" class="text-[10px] text-red-300 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                                        <a :href="getNavUrl(item)" target="_blank" class="text-[10px] bg-green-50 text-green-600 px-3 py-1.5 rounded-full font-bold ml-auto flex items-center hover:bg-green-100"><i class="fa-solid fa-location-arrow mr-1"></i> å°èˆª</a>
                                        <button v-if="index > 0 && !currentItinerary[index-1].isFlight" @click="planRouteFromPrev(item, index)" class="text-[10px] bg-blue-50 text-blue-600 px-3 py-1.5 rounded-full font-bold flex items-center hover:bg-blue-100"><i class="fa-solid fa-route mr-1"></i> è·¯ç·š</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallet (Summary Logic) -->
        <div v-if="currentView === 'wallet'" class="pb-20">
            <div class="flex justify-between items-center mb-2 px-1">
                <h2 class="text-xl font-bold theme-text">æ—…è²»è¨˜å¸³</h2>
                <div class="flex gap-2">
                    <button @click="modals.group = true" class="text-xs bg-white text-gray-500 px-3 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center"><i class="fa-solid fa-users mr-1"></i> æ—…ä¼´ç¾¤çµ„</button>
                    <button @click="modals.budget = true" class="text-xs bg-white text-gray-500 px-3 py-1.5 rounded-full shadow-sm border border-gray-100 flex items-center"><i class="fa-solid fa-pen mr-1"></i> ç·¨è¼¯é ç®—</button>
                </div>
            </div>
            
            <div class="bg-white rounded-3xl p-5 shadow-lg mb-4 border border-gray-100 relative">
                <div class="flex justify-between items-center mb-3">
                    <div class="text-gray-400 text-xs font-bold flex items-center"><i class="fa-solid fa-piggy-bank mr-1"></i> ç¸½é ç®— (TWD)</div>
                    <div class="text-2xl font-bold theme-text">{{ settings.budget.toLocaleString('zh-TW') }}</div>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                    <div class="h-2.5 rounded-full transition-all duration-500" :class="getBudgetBgClass()" :style="{width: `${Math.min(100, Math.max(0, tripStats.percentage))}%`}"></div>
                </div>
                <div class="flex justify-between items-center text-xs font-bold text-gray-500">
                    <span>å·²èŠ±è²»(æˆ‘): {{ tripStats.spent.toLocaleString('zh-TW') }}</span>
                    <span :class="getBudgetColorClass()">å‰©é¤˜: {{ tripStats.remaining.toLocaleString('zh-TW') }}</span>
                </div>
            </div>

            <!-- ç¸½çµé é¢é‚è¼¯ -->
            <div v-if="selectedDayIdx === 'summary'">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-dark">ç¸½èŠ±è²»çµ±è¨ˆ (æˆ‘ä»˜çš„)</h3>
                    <select v-model="summaryFilter" class="text-xs bg-gray-100 p-1 rounded border-none outline-none">
                        <option value="all">å…¨éƒ¨åˆ†é¡</option>
                        <option v-for="cat in Object.keys(categoryLabels)" :key="cat" :value="cat">{{ categoryLabels[cat] }}</option>
                    </select>
                </div>
                
                <!-- ç¸½çµçš„åˆ†é¡çµ±è¨ˆ -->
                <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-2 mb-4">
                    <div v-for="({cat, amt}) in categories" :key="cat" class="flex items-center text-[10px] bg-gray-50 px-2 py-1 rounded-lg flex-shrink-0"><div class="w-2 h-2 rounded-full mr-1" :style="{backgroundColor: getCategoryHex(cat)}"></div>{{ getCategoryLabel(cat) }} {{ Math.round(amt/tripTotalTwd*100) }}%</div>
                </div>

                <!-- çµç®—å ±è¡¨ (åªåœ¨ç¸½çµé é¡¯ç¤º) -->
                <div v-if="calculatedTransfers.length > 0" class="mb-4 bg-yellow-50 rounded-2xl p-4 border border-yellow-200">
                    <h3 class="text-sm font-bold text-yellow-800 mb-2 flex items-center"><i class="fa-solid fa-handshake mr-2"></i> åˆ†å¸³çµç®—</h3>
                    <div class="space-y-1">
                        <div v-for="t in calculatedTransfers" :key="t.from+t.to" class="text-xs">
                            <span class="font-bold text-red-600">{{ t.from }}</span> çµ¦ <span class="font-bold text-green-600">{{ t.to }}</span>ï¼š<span class="font-mono font-bold theme-text">{{ t.amount.toLocaleString('zh-TW') }}</span>
                        </div>
                    </div>
                </div>

                <!-- æ‰€æœ‰æ˜ç´°åˆ—è¡¨ (ä¾æ—¥æœŸç”±èˆŠåˆ°æ–°æ’åº) -->
                <div class="space-y-3 pb-10">
                    <div v-for="ex in filteredSummaryExpenses" :key="ex.id" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :style="{borderColor: getCategoryHex(ex.category)}">
                        <div class="flex-1 mr-4">
                            <div class="text-sm font-bold text-gray-700">{{ ex.item }}</div>
                            <div class="text-[10px] text-gray-400 flex flex-wrap mt-1">
                                <span class="mr-2 bg-gray-100 px-1 rounded">{{ ex.date }}</span>
                                <span class="mr-1 font-bold">{{ ex.payer }}</span>
                                <span>å…ˆä»˜ <span class="text-gray-500">({{ ex.forWhom.length === settings.travelers.length ? 'å¹³åˆ†' : ex.forWhom.join(', ') }})</span></span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold font-mono theme-text">{{ ex.currency }} {{ ex.amount }}</div>
                            <div v-if="ex.currency !== 'TWD'" class="text-[10px] text-gray-400">â‰ˆ {{ Math.round(ex.amount * ((settings.rates && settings.rates[ex.currency])||1)) }}</div>
                        </div>
                    </div>
                    <div v-if="filteredSummaryExpenses.length===0" class="text-center text-gray-300 py-4">ç„¡è³‡æ–™</div>
                </div>
            </div>

            <!-- å–®æ—¥è¨˜å¸³é é¢ -->
            <div v-else>
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold text-dark">
                        {{ selectedDayIdx === -1 ? 'è¡Œå‰èŠ±è²»' : 'ä»Šæ—¥èŠ±è²»(æˆ‘)' }}: TWD {{ dayTotalTwd.toLocaleString('zh-TW') }}
                    </h3>
                </div>

                <!-- æ–°å¢èŠ±è²»å€å¡Š -->
                <div class="bg-white rounded-3xl p-5 shadow-sm mb-4 border border-gray-100 relative" :class="{'ring-2 theme-ring': editingExpenseId}">
                    <div v-if="editingExpenseId" class="absolute -top-3 left-4 bg-gray-600 text-white text-[10px] px-2 py-1 rounded">ç·¨è¼¯ä¸­</div>
                    <div class="mb-3"><input v-model="newExpense.item" placeholder="å“é … (å¦‚: æ™šé¤)" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                    <div class="flex mb-4 gap-3">
                        <div class="w-1/2 overflow-hidden flex flex-col">
                            <div class="text-[10px] text-gray-400 mb-1 ml-1">èª°ä»˜çš„éŒ¢?</div>
                            <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1">
                                <button v-for="p in settings.travelers" :key="p" @click="newExpense.payer = p" class="member-pill px-3 py-1.5 rounded-xl text-xs font-bold flex-shrink-0 whitespace-nowrap" :class="newExpense.payer === p ? 'active' : 'inactive'">{{ p }}</button>
                            </div>
                        </div>
                        <div class="w-1/2 overflow-hidden border-l border-gray-100 pl-2">
                             <div class="text-[10px] text-gray-400 mb-1 ml-1">èª°æ¶ˆè²»çš„?</div>
                            <div class="flex space-x-2 overflow-x-auto hide-scrollbar pb-1">
                                <button v-for="p in settings.travelers" :key="p" @click="toggleSplit(p)" class="member-pill px-3 py-1.5 rounded-xl text-xs font-bold flex-shrink-0 whitespace-nowrap flex items-center" :class="newExpense.forWhom.includes(p) ? 'active' : 'inactive'">{{ p }}<i v-if="newExpense.forWhom.includes(p)" class="fa-solid fa-check ml-1 text-[10px]"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-2 mb-3">
                        <select v-model="newExpense.category" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700">
                            <option value="food">ğŸ½ï¸ é¤é£²</option><option value="traffic">ğŸš— äº¤é€š</option><option value="accommodation">ğŸ¨ ä½å®¿</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="entertainment">ğŸ¡ å¨›æ¨‚</option><option value="other">ğŸ’¡ å…¶ä»–</option>
                        </select>
                        <select v-model="newExpense.currency" class="flex-shrink-0 bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700 w-20 text-center">
                            <option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option>
                        </select>
                    </div>
                    <!-- é‡‘é¡èˆ‡æ–°å¢æŒ‰éˆ•ä¸¦æ’ -->
                    <div class="flex gap-2">
                        <input type="number" v-model="newExpense.amount" placeholder="é‡‘é¡" class="flex-1 bg-gray-50 p-3 rounded-xl text-xl outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center" min="0">
                        <button @click="saveExpense" class="w-24 theme-bg text-white rounded-xl font-bold text-sm shadow-md flex items-center justify-center">{{ editingExpenseId ? 'æ›´æ–°' : 'æ–°å¢' }}</button>
                        <button v-if="editingExpenseId" @click="cancelEditExpense" class="w-16 bg-gray-100 text-gray-500 rounded-xl font-bold text-xs">å–æ¶ˆ</button>
                    </div>
                </div>

                <div class="space-y-3 pb-10 min-h-[50px]">
                    <div v-if="currentDayExpenses.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-receipt text-4xl mb-3"></i><p>ç„¡è¨˜å¸³</p></div>
                    <div v-for="ex in currentDayExpenses" :key="ex.id" class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :style="{borderColor: getCategoryHex(ex.category)}">
                        <div class="flex-1 mr-4">
                            <div class="text-sm font-bold text-gray-700">{{ ex.item }}</div>
                            <div class="text-[10px] text-gray-400 flex flex-wrap mt-1">
                                <span class="mr-1 font-bold">{{ ex.payer }}</span>
                                <span>å…ˆä»˜ <span class="text-gray-500">({{ ex.forWhom.length === settings.travelers.length ? 'å¹³åˆ†' : ex.forWhom.join(', ') }})</span></span>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <div class="text-right mr-3">
                                <div class="text-sm font-bold font-mono theme-text">{{ ex.currency }} {{ ex.amount }}</div>
                                <div v-if="ex.currency !== 'TWD'" class="text-[10px] text-gray-400">â‰ˆ {{ Math.round(ex.amount * ((settings.rates && settings.rates[ex.currency])||1)) }}</div>
                            </div>
                            <button @click="editExpense(ex)" class="text-gray-300 hover:text-blue-400 p-1 mr-1"><i class="fa-solid fa-pen"></i></button>
                            <button @click="deleteExpense(ex.id)" class="text-gray-300 hover:text-red-400 p-1"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shopping -->
        <div v-if="currentView === 'shopping'" class="pb-20">
            <h2 class="text-xl font-bold theme-text mb-4">è³¼ç‰©æ¸…å–®</h2>
            <div class="flex space-x-2 mb-6">
                <input v-model="newShopItem" @keyup.enter="addShopItem" placeholder="æ–°å¢è³¼ç‰©æ¸…å–®é …ç›®..." class="flex-1 bg-white p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700">
                <button @click="addShopItem" class="w-10 h-10 theme-bg text-white rounded-xl shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-plus text-lg"></i></button>
            </div>
            <div class="space-y-3 pb-20">
                <div v-for="item in shoppingList" :key="item.id" class="flex items-center bg-white p-4 rounded-2xl shadow-sm border-l-4" :class="item.done ? 'border-gray-200' : 'theme-border'">
                    <input type="checkbox" v-model="item.done" class="w-5 h-5 theme-text rounded focus:ring-0 cursor-pointer" :class="{'opacity-50': item.done}">
                    <span class="ml-3 flex-1 text-sm text-gray-700" :class="{'line-through text-gray-300': item.done}">{{ item.text }}</span>
                    <button @click="deleteShopItem(item.id)" class="text-gray-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div v-if="shoppingList.length === 0" class="text-center py-10 text-gray-300"><i class="fa-solid fa-cart-shopping text-4xl mb-3"></i><p>é»æ“Šä¸Šæ–¹æŒ‰éˆ•æ–°å¢è³¼ç‰©æ¸…å–®</p></div>
            </div>
        </div>

        <!-- Info -->
        <div v-if="currentView === 'info'" class="pb-20">
            <h2 class="text-xl font-bold theme-text mb-4">è³‡è¨Šç«™</h2>
            <div class="theme-bg rounded-3xl p-4 text-white shadow-sm mb-4 flex items-center justify-between relative overflow-hidden">
                <div class="z-10">
                    <div class="text-xs opacity-80 mb-1 flex items-center"><i class="fa-solid fa-location-dot mr-1"></i> {{ weather.location || 'å®šä½ä¸­...' }}</div>
                    <div class="flex items-end">
                        <span class="text-3xl font-bold mr-2">{{ weather.temp }}Â°C</span>
                        <span class="text-sm font-bold">{{ weather.desc }}</span>
                    </div>
                    <div class="text-xs font-bold mt-1 opacity-90 flex items-center"><i class="fa-solid fa-umbrella mr-1"></i> é™é›¨ {{ weather.rain || 0 }}%</div>
                </div>
                <div class="z-10 text-4xl opacity-90"><i :class="weather.icon"></i></div>
                <button @click="fetchWeather" class="absolute top-2 right-2 text-white/70 hover:text-white text-xs"><i class="fa-solid fa-rotate-right" :class="{'fa-spin': weather.loading}"></i></button>
            </div>
            
            <div class="bg-white rounded-3xl p-5 shadow-sm mb-6 border border-gray-100 relative" :class="{'ring-2 theme-ring': editingInfoId}">
                <div v-if="editingInfoId" class="absolute -top-3 left-4 bg-gray-600 text-white text-[10px] px-2 py-1 rounded">ç·¨è¼¯ä¸­</div>
                <input v-model="newInfo.title" placeholder="æ¨™é¡Œ (å¦‚: é£¯åº—Wifiå¯†ç¢¼)" class="w-full mb-2 border-b border-gray-100 pb-2 text-sm outline-none font-bold">
                <textarea v-model="newInfo.content" placeholder="å…§å®¹..." rows="2" class="w-full text-sm outline-none text-gray-500 resize-none"></textarea>
                <div class="text-right mt-2 flex justify-end space-x-2">
                    <button v-if="editingInfoId" @click="cancelEditInfo" class="text-xs text-gray-400">å–æ¶ˆ</button>
                    <button @click="saveInfo" class="text-xs theme-bg text-white px-4 py-2 rounded-xl font-bold">{{ editingInfoId ? 'æ›´æ–°' : 'æ–°å¢' }}</button>
                </div>
            </div>

            <div class="space-y-3 pb-20">
                <div v-for="info in infoList" :key="info.id" class="bg-white p-5 rounded-2xl shadow-sm border-l-4 theme-border relative group">
                    <div class="flex justify-between items-start">
                        <h3 class="text-lg font-bold text-gray-700">{{ info.title }}</h3>
                        <div class="text-gray-300 flex space-x-2 opacity-0 group-hover:opacity-100 transition">
                            <button @click="editInfo(info)" class="hover:text-blue-400"><i class="fa-solid fa-pen"></i></button>
                            <button @click="deleteInfo(info.id)" class="hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    <pre class="text-sm text-gray-500 whitespace-pre-wrap mt-1">{{ info.content }}</pre>
                </div>
            </div>
        </div>

        <!-- Translate -->
        <div v-if="currentView === 'translate'" class="h-full flex flex-col pb-20">
            <h2 class="text-xl font-bold theme-text mb-4">å³æ™‚ç¿»è­¯</h2>
            <textarea v-model="transText" @input="debouncedTranslate" placeholder="è¼¸å…¥è¦ç¿»è­¯çš„å…§å®¹ (æ”¯æ´ä¸­æ–‡/è‹±/æ—¥/éŸ“)" class="w-full h-32 bg-white rounded-3xl p-5 shadow-sm outline-none text-lg resize-none mb-4 border-2 border-transparent focus:border-gray-200"></textarea>

            <div class="flex-1 overflow-y-auto space-y-4">
                <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 theme-border relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div class="text-xs text-gray-400 font-bold">JAPANESE</div>
                        <button @click="speak(translations.ja, 'ja-JP')" class="text-gray-400 hover:text-theme transition"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.ja)">{{ translations.ja || '...' }}</div>
                    <button @click="openFullscreen(translations.ja)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-blue-400 relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div class="text-xs text-gray-400 font-bold">ENGLISH</div>
                        <button @click="speak(translations.en, 'en-US')" class="text-gray-400 hover:text-blue-600 transition"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.en)">{{ translations.en || '...' }}</div>
                    <button @click="openFullscreen(translations.en)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                </div>
                <div class="bg-white rounded-2xl p-5 shadow-sm border-l-4 border-green-400 relative group">
                    <div class="flex justify-between items-start mb-1">
                        <div class="text-xs text-gray-400 font-bold">KOREAN</div>
                        <button @click="speak(translations.ko, 'ko-KR')" class="text-gray-400 hover:text-green-600 transition"><i class="fa-solid fa-volume-high"></i></button>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 min-h-[6rem] whitespace-pre-wrap break-words leading-relaxed" @click="openFullscreen(translations.ko)">{{ translations.ko || '...' }}</div>
                    <button @click="openFullscreen(translations.ko)" class="absolute bottom-4 right-4 text-gray-300 hover:text-gray-500"><i class="fa-solid fa-expand"></i></button>
                </div>
            </div>
        </div>
    </main>

    <!-- Navigation -->
    <nav class="absolute bottom-0 left-0 right-0 h-16 bg-white shadow-2xl z-30 flex items-center px-4 rounded-t-3xl border-t border-gray-100">
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'itinerary' }" @click="switchView('itinerary')"><i class="fa-solid fa-map-location-dot"></i><span>è¡Œç¨‹</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'wallet' }" @click="switchView('wallet')"><i class="fa-solid fa-wallet"></i><span>è¨˜å¸³</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'shopping' }" @click="switchView('shopping')"><i class="fa-solid fa-cart-shopping"></i><span>è³¼ç‰©</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'info' }" @click="switchView('info')"><i class="fa-solid fa-circle-info"></i><span>è³‡è¨Š</span></div>
        <div class="bottom-nav-item" :class="{ 'active': currentView === 'translate' }" @click="switchView('translate')"><i class="fa-solid fa-language"></i><span>ç¿»è­¯</span></div>
    </nav>
    
    <!-- Modals -->
    <div v-if="modals.item" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.item = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold theme-text mb-4">{{ editingItem ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
            <div class="space-y-4">
                <div class="flex space-x-3">
                    <div class="flex-1"><label class="text-xs text-gray-400">æ™‚é–“ (24H)</label><div class="flex space-x-1 items-center"><select v-model="form.hour" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring text-sm font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span class="text-gray-400">:</span><select v-model="form.minute" class="bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring text-sm font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                    <div class="flex-1"><label class="text-xs text-gray-400">åœ°é» <span class="text-[10px] text-red-400 ml-1 font-bold">* (å¿…å¡«)</span></label><input v-model="form.location" class="w-full bg-gray-50 p-3 rounded-xl outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                </div>
                <div class="flex space-x-3">
                    <div class="flex-1"><label class="text-xs text-gray-400">åˆ†é¡</label><select v-model="form.category" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"><option value="travel">âœˆï¸ äº¤é€š</option><option value="food">ğŸ½ï¸ é¤é£²</option><option value="accommodation">ğŸ¨ ä½å®¿</option><option value="activity">ğŸƒ æ´»å‹•</option><option value="shopping">ğŸ›ï¸ è³¼ç‰©</option><option value="other">ğŸ’¡ å…¶ä»–</option></select></div>
                    <div class="flex-1"><label class="text-xs text-gray-400">è²»ç”¨ (TWD)</label><input type="number" v-model="form.cost" placeholder="0" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700" min="0"></div>
                </div>
                <div>
                    <label class="text-xs text-gray-400">ç¶²å€ (Google Maps æˆ–å…¶ä»–)</label>
                    <div class="flex space-x-2"><input v-model="urlInput" placeholder="è²¼ä¸Šç¶²å€æˆ–åœ°æ¨™åç¨±" class="flex-1 bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring text-gray-700"><button @click="parseUrl" class="w-10 h-10 theme-bg text-white rounded-xl shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-magnifying-glass"></i></button></div>
                    <div v-if="urlStatus === 'success'" class="text-[10px] text-green-600 font-bold mt-1">é€£çµå·²å„²å­˜ <span v-if="autoFilledName" class="theme-text">åç¨±: {{ autoFilledName }}</span></div>
                </div>
                <div><label class="text-xs text-gray-400">å‚™è¨»</label><textarea v-model="form.note" rows="2" class="w-full bg-gray-50 p-3 rounded-xl outline-none resize-none focus:ring-2 theme-ring"></textarea></div>
            </div>
            <div class="flex space-x-3 mt-6"><button @click="modals.item = false" class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-500 font-bold text-sm">å–æ¶ˆ</button><button @click="saveItem" class="flex-1 py-3 rounded-xl theme-bg font-bold text-sm shadow-lg hover:opacity-90">å„²å­˜</button></div>
        </div>
    </div>

    <div v-if="modals.settings" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.settings = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold mb-4 text-center">è¨­å®š</h3>
            <div class="space-y-4">
                <div><label class="text-xs text-gray-400">è¡Œç¨‹åç¨±</label><input v-model="settings.title" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div>
                <div class="flex space-x-3"><div class="flex-1"><label class="text-xs text-gray-400">å‡ºç™¼æ—¥æœŸ</label><input type="date" v-model="settings.startDate" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div><div class="flex-1"><label class="text-xs text-gray-400">çµæŸæ—¥æœŸ</label><input type="date" v-model="settings.endDate" class="w-full bg-gray-50 p-3 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700"></div></div>
                <div><label class="text-xs text-gray-400 block mb-1">ä¸»é¡Œè‰²</label><div class="flex space-x-3"><button @click="changeColor('#60A5FA')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#60A5FA]"></button><button @click="changeColor('#F97316')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#F97316]"></button><button @click="changeColor('#EF4444')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#EF4444]"></button><button @click="changeColor('#00B894')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#00B894]"></button><button @click="changeColor('#4ADE80')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#4ADE80]"></button><button @click="changeColor('#C084FC')" class="w-8 h-8 rounded-full border-2 border-white shadow-md bg-[#C084FC]"></button></div></div>
                <hr class="border-gray-100">
                <h4 class="text-sm font-bold text-gray-600">åŒ¯ç‡è¨­å®š (TWD=1)</h4>
                <!-- 2x2 Grid Layout with shorter inputs -->
                <div class="grid grid-cols-2 gap-3">
                    <div v-for="c in Object.keys(settings.rates)" :key="c" class="flex items-center space-x-2"><label class="w-10 text-sm font-mono text-gray-700 text-right">{{ c }}:</label><input type="number" v-model.number="settings.rates[c]" :placeholder="c" class="w-24 bg-gray-50 p-2 rounded-xl text-sm outline-none focus:ring-2 theme-ring font-bold text-gray-700" min="0" step="0.001"></div>
                </div>
                <button @click="updateRates" class="w-full py-2 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold hover:bg-blue-100"><i class="fa-solid fa-cloud-arrow-down mr-1"></i> æ›´æ–°å³æ™‚åŒ¯ç‡</button>
                <hr class="border-gray-100">
                <div class="flex space-x-2"><button @click="exportData" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-gray-200"><i class="fa-solid fa-download mr-1"></i> å‚™ä»½</button><button @click="triggerImport" class="flex-1 py-2 bg-gray-100 text-gray-600 rounded-xl text-xs font-bold hover:bg-gray-200"><i class="fa-solid fa-upload mr-1"></i> åŒ¯å…¥</button><button @click="resetData" class="flex-1 py-2 bg-red-50 text-red-500 rounded-xl text-xs font-bold hover:bg-red-100"><i class="fa-solid fa-trash mr-1"></i> é‡ç½®</button></div>
                <input type="file" ref="fileInput" accept=".json" class="hidden" @change="handleImport">
            </div>
            <div class="text-center mt-6"><button @click="modals.settings = false" class="text-sm font-bold theme-text">é—œé–‰</button></div>
        </div>
    </div>

    <!-- Flight Modal -->
    <div v-if="modals.flight" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6" @click.self="modals.flight = false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h3 class="text-lg font-bold theme-text mb-4">ç·¨è¼¯èˆªç­</h3>
            <div class="space-y-4 mb-4">
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex space-x-2 mb-2 relative">
                        <div class="w-1/2 relative">
                            <label class="text-[10px] text-gray-400">å‡ºç™¼åœ°</label>
                            <input v-model="tempFlight.from" @input="searchAirport(tempFlight.from, 'dep')" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-center uppercase text-sm" placeholder="ä»£è™Ÿ/ä¸­æ–‡">
                            <div v-if="suggestions.type === 'dep' && suggestions.list.length > 0" class="suggestion-list">
                                <div v-for="s in suggestions.list" :key="s.code" @click="selectAirport(s, 'dep')" class="suggestion-item">
                                    <span class="font-bold">{{ s.code }}</span><span class="text-gray-500 ml-2">{{ s.cityZh }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="w-1/2 relative">
                            <label class="text-[10px] text-gray-400">ç›®çš„åœ°</label>
                            <input v-model="tempFlight.to" @input="searchAirport(tempFlight.to, 'arr')" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-center uppercase text-sm" placeholder="ä»£è™Ÿ/ä¸­æ–‡">
                             <div v-if="suggestions.type === 'arr' && suggestions.list.length > 0" class="suggestion-list">
                                <div v-for="s in suggestions.list" :key="s.code" @click="selectAirport(s, 'arr')" class="suggestion-item">
                                    <span class="font-bold">{{ s.code }}</span><span class="text-gray-500 ml-2">{{ s.cityZh }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-2"><input v-model="tempFlight.airline" placeholder="èˆªç©ºå…¬å¸" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm"></div>
                    <div class="mb-2"><input v-model="tempFlight.code" placeholder="èˆªç­ä»£è™Ÿ" class="w-full bg-white p-2 rounded-lg outline-none font-bold text-sm"></div>
                    <div class="flex space-x-2 mb-2">
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">å‡ºç™¼æ—¥æœŸ</label><input type="date" v-model="tempFlight.date" class="w-full bg-white p-1 rounded outline-none text-xs text-center font-bold"></div>
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">æŠµé”æ—¥æœŸ</label><input type="date" v-model="tempFlight.arriveDate" class="w-full bg-white p-1 rounded outline-none text-xs text-center font-bold"></div>
                    </div>
                    <div class="flex space-x-2 mb-2">
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">å‡ºç™¼ (24H)</label><div class="flex space-x-1 items-center"><select v-model="tempFlight.hour" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span>:</span><select v-model="tempFlight.minute" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                        <div class="w-1/2"><label class="text-[10px] text-gray-400">æŠµé” (24H)</label><div class="flex space-x-1 items-center"><select v-model="tempFlight.arriveHour" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option></select><span>:</span><select v-model="tempFlight.arriveMinute" class="bg-white p-1 rounded outline-none text-xs font-mono flex-1 text-center"><option v-for="m in 12" :key="m" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option></select></div></div>
                    </div>
                    <!-- ç§»é™¤æŒ‰éˆ• -->
                    <button v-if="editingFlightItem" @click="removeFlightItem" class="mt-2 w-full text-xs text-red-400 border border-red-200 rounded py-1 hover:bg-red-50">ç§»é™¤æ­¤èˆªç­</button>
                </div>
            </div>
            <button @click="saveFlight" class="w-full py-3 theme-bg text-white rounded-xl font-bold text-sm shadow-md">å„²å­˜</button>
        </div>
    </div>

    <div v-if="modals.calc" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[70] flex items-center justify-center p-6 fade-enter-active" @click.self="modals.calc=false">
        <div class="bg-white w-full max-w-xs rounded-3xl p-5 shadow-2xl">
            <h3 class="text-center font-bold text-lg mb-3 theme-text">å¿«é€Ÿæ›ç®—</h3>
            <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-100">
                <div class="flex justify-between mb-1"><span class="text-xs text-gray-400">æ›ç®—çµæœ (TWD)</span><span class="font-bold text-lg theme-text font-mono">TWD {{ calcResult.toLocaleString('zh-TW') }}</span></div>
                <div class="flex justify-between items-center mt-3"><select v-model="calcCurrency" class="bg-white p-2 rounded-lg text-sm outline-none font-bold text-gray-700"><option v-for="c in Object.keys(settings.rates)" :key="c" :value="c">{{ c }}</option></select><input type="number" v-model="calcInput" placeholder="è¼¸å…¥é‡‘é¡" class="w-1/2 bg-white p-2 rounded-lg text-lg outline-none font-bold text-gray-700 text-right font-mono" min="0"></div>
            </div>
            <div class="text-center"><button @click="modals.calc=false" class="text-sm font-bold theme-text">é—œé–‰</button></div>
        </div>
    </div>

    <div v-if="modals.fullscreen" class="fixed inset-0 bg-white z-[80] flex flex-col p-6" @click.self="modals.fullscreen=false">
        <div class="flex-1 overflow-y-auto whitespace-pre-wrap break-words text-3xl font-bold text-gray-800 p-4 leading-relaxed">{{ fullscreenText }}</div>
        <div class="text-center mt-6"><button @click="modals.fullscreen=false" class="text-sm font-bold theme-text">é—œé–‰</button></div>
    </div>

    <div v-if="modals.group" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-enter-active" @click.self="modals.group=false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">æ—…ä¼´ç¾¤çµ„ç®¡ç†</h3>
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-100 mb-4">
                <div class="flex flex-wrap gap-2 mb-3"><span v-for="(p, idx) in settings.travelers" :key="p" class="bg-white px-3 py-1.5 rounded-xl text-sm border flex items-center shadow-sm">{{ p }}<button v-if="idx>0" @click="removeTraveler(idx)" class="ml-2 text-red-300 hover:text-red-500">Ã—</button></span></div>
                <div class="flex gap-2"><input v-model="newTravelerName" @keyup.enter="addTraveler" placeholder="æ–°å¢æ—…ä¼´åç¨±..." class="flex-1 bg-white p-2 rounded-lg text-sm outline-none font-bold text-gray-700"><button @click="addTraveler" class="w-10 h-10 theme-bg text-white rounded-lg shadow-sm flex items-center justify-center hover:opacity-90 active:scale-95 transition"><i class="fa-solid fa-plus text-lg"></i></button></div>
            </div>
            <div class="text-center"><button @click="modals.group=false" class="text-sm font-bold theme-text">é—œé–‰</button></div>
        </div>
    </div>

    <div v-if="modals.budget" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 flex items-center justify-center p-6 fade-enter-active" @click.self="modals.budget=false">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
            <h3 class="text-lg font-bold mb-4 text-center">ç·¨è¼¯é ç®—</h3>
            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4"><label class="text-xs text-gray-400">ç¸½é ç®— (TWD)</label><input type="number" v-model.number="settings.budget" placeholder="0" class="w-full bg-white p-3 rounded-xl text-2xl outline-none focus:ring-2 theme-ring font-bold text-gray-700 text-center" min="0"></div>
            <div class="text-center flex justify-end"><button @click="editBudget" class="py-2 px-6 theme-bg text-white rounded-xl font-bold text-sm shadow-md">å„²å­˜</button></div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, nextTick, reactive, onMounted, watch } = Vue;

    const airData = "TPE,Taipei,å°åŒ—,8|TSA,Taipei,å°åŒ—æ¾å±±,8|KHH,Kaohsiung,é«˜é›„,8|NRT,Tokyo,æ±äº¬æˆç”°,9|HND,Tokyo,æ±äº¬ç¾½ç”°,9|KIX,Osaka,å¤§é˜ª,9|FUK,Fukuoka,ç¦å²¡,9|OKA,Okinawa,æ²–ç¹©,9|CTS,Sapporo,æœ­å¹Œ,9|ICN,Seoul,é¦–çˆ¾ä»å·,9|GMP,Seoul,é¦–çˆ¾é‡‘æµ¦,9|PUS,Busan,é‡œå±±,9|CJU,Jeju,æ¿Ÿå·,9|BKK,Bangkok,æ›¼è°·,7|DMK,Bangkok,æ›¼è°·å»Šæ›¼,7|HKG,Hong Kong,é¦™æ¸¯,8|SIN,Singapore,æ–°åŠ å¡,8|KUL,Kuala Lumpur,å‰éš†å¡,8|SGN,Ho Chi Minh,èƒ¡å¿—æ˜,7|HAN,Hanoi,æ²³å…§,7|MNL,Manila,é¦¬å°¼æ‹‰,8|CEB,Cebu,å®¿éœ§,8|DPS,Bali,å³‡é‡Œå³¶,8|LAX,Los Angeles,æ´›æ‰ç£¯,-8|SFO,San Francisco,èˆŠé‡‘å±±,-8|JFK,New York,ç´ç´„,-5|LHR,London,å€«æ•¦,0|CDG,Paris,å·´é»,1|AMS,Amsterdam,é˜¿å§†æ–¯ç‰¹ä¸¹,1|FRA,Frankfurt,æ³•è˜­å…‹ç¦,1|DXB,Dubai,æœæ‹œ,4|SYD,Sydney,é›ªæ¢¨,11|MEL,Melbourne,å¢¨çˆ¾æœ¬,11|YVR,Vancouver,æº«å“¥è¯,-8|YYZ,Toronto,å¤šå€«å¤š,-5|MUC,Munich,æ…•å°¼é»‘,1|FCO,Rome,ç¾…é¦¬,1|BCN,Barcelona,å·´å¡éš†ç´,1|MAD,Madrid,é¦¬å¾·é‡Œ,1";
    const airports = airData.split('|').map(s => {
        const p = s.split(',');
        return { code: p[0], city: p[1], cityZh: p[2], tz: parseInt(p[3]) };
    });

    const app = createApp({
        setup() {
            const settings = reactive({ title: 'Travel Go!!!', startDate: new Date().toISOString().split('T')[0], endDate: new Date(Date.now()+3*86400000).toISOString().split('T')[0], rates: { JPY: 0.22, KRW: 0.024, USD: 32, TWD: 1 }, color: '#60A5FA', budget: 0, travelers: ['æˆ‘'] });
            const flights = reactive({ dep: { code: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 }, ret: { code: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', extra: [], date: '', arriveDate: '', depTz: 8, arriveTz: 8 } });
            const itineraryData = ref({});
            const expenses = ref([]);
            const todoList = ref([{id:1, text:'å…Œæ›å¤–å¹£', done:false}, {id:2, text:'è³¼è²·æ—…éŠä¿éšª', done:false}]);
            const shoppingList = ref([]);
            const infoList = ref([]);
            const modals = reactive({ item: false, settings: false, flight: false, calc: false, fullscreen: false, group: false, budget: false });
            const currentView = ref('itinerary');
            const selectedDayIdx = ref(0);
            const form = ref({ id: null, hour: '10', minute: '00', location: '', category: 'activity', cost: null, note: '', sourceUrl: '' });
            const editingItem = ref(null);
            const editingFlightItem = ref(null);
            const urlInput = ref('');
            const urlStatus = ref(null);
            const autoFilledName = ref('');
            const newExpense = reactive({ id: null, item: '', amount: null, currency: 'TWD', category: 'food', payer: 'æˆ‘', forWhom: ['æˆ‘'], date: new Date().toISOString().split('T')[0] });
            const editingExpenseId = ref(null);
            const newShopItem = ref('');
            const newInfo = reactive({ id: null, title: '', content: '' });
            const editingInfoId = ref(null);
            const editingFlightType = ref('dep');
            const tempFlight = ref({});
            const weather = reactive({ temp: '--', icon: 'fa-solid fa-cloud', desc: 'è¼‰å…¥ä¸­...', rain: 0, loading: false, location: '' });
            const transText = ref('');
            const translations = reactive({ ja: '', en: '', ko: '' });
            const fullscreenText = ref('');
            let transTimeout = null;
            const newTravelerName = ref('');
            const calcInput = ref('');
            const calcCurrency = ref('JPY');
            const autoSaveStatus = ref(false);
            const fileInput = ref(null);
            const sortableList = ref(null);
            const suggestions = reactive({ list: [], type: '' });
            const summaryFilter = ref('all');
            const STORAGE_KEY = 'okinawa_go_v88_8_data';
            const categoryLabels = { food: 'é¤é£²', traffic: 'äº¤é€š', accommodation: 'ä½å®¿', shopping: 'è³¼ç‰©', entertainment: 'å¨›æ¨‚', other: 'å…¶ä»–' };

            const calcResult = computed(() => { if(!calcInput.value) return 0; return Math.round(parseFloat(calcInput.value) * (settings.rates[calcCurrency.value]||1)); });
            const computedDates = computed(() => {
                const arr = []; const s = new Date(settings.startDate); const days = Math.ceil(Math.abs(new Date(settings.endDate)-s)/86400000)+1; const weekdays = ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
                for(let i=0; i<days; i++) { const d = new Date(s); d.setDate(s.getDate()+i); arr.push({ dayLabel: `DAY ${i+1}`, dateLabel: `${d.getMonth()+1}/${d.getDate()} (${weekdays[d.getDay()]})` }); }
                return arr;
            });

            const currentItinerary = computed(() => {
                let items = [...(itineraryData.value[selectedDayIdx.value] || [])];
                if(selectedDayIdx.value === 0 && flights.dep.code) { items.push({isFlight:true, type:'dep', ...flights.dep, title:'å»ç¨‹èˆªç­'}); }
                if(selectedDayIdx.value === computedDates.value.length-1 && flights.ret.code) { items.push({isFlight:true, type:'ret', ...flights.ret, title:'å›ç¨‹èˆªç­'}); }
                return items.sort((a,b) => (a.time||'00:00').localeCompare(b.time||'00:00')).filter((v,i,a) => v && (v.id || v.code));
            });

            const tripStats = computed(() => { 
                const myExpenses = expenses.value.filter(e => e.payer === 'æˆ‘');
                const spent = Math.round(myExpenses.reduce((s,e)=>s+parseFloat(e.amount)*(e.currency==='TWD'?1:(settings.rates[e.currency]||1)),0)); 
                return { spent, remaining: settings.budget-spent, percentage: settings.budget>0?(spent/settings.budget)*100:0 }; 
            });

            const currentDayExpenses = computed(() => {
                if (selectedDayIdx.value === 'summary') return [];
                let targetDate;
                if (selectedDayIdx.value === -1) {
                    const d = new Date(settings.startDate); d.setDate(d.getDate() - 1);
                    targetDate = d.toISOString().split('T')[0];
                } else {
                    targetDate = new Date(new Date(settings.startDate).getTime()+selectedDayIdx.value*86400000).toISOString().split('T')[0];
                }
                return expenses.value.filter(e => e.date === targetDate);
            });

            const dayTotalTwd = computed(() => {
                return currentDayExpenses.value.filter(e => e.payer === 'æˆ‘').reduce((s,e)=>s+parseFloat(e.amount)*(e.currency==='TWD'?1:(settings.rates[e.currency]||1)),0);
            });

            const tripTotalTwd = computed(() => tripStats.value.spent);
            
            const filteredSummaryExpenses = computed(() => { 
                let list = expenses.value.sort((a,b) => new Date(a.date) - new Date(b.date)); 
                if (summaryFilter.value !== 'all') list = list.filter(e => e.category === summaryFilter.value); 
                return list; 
            });
            
            const categories = computed(() => { 
                const c={food:0,traffic:0,accommodation:0,shopping:0,entertainment:0,other:0}; 
                expenses.value.filter(e => e.payer === 'æˆ‘').forEach(e=>{c[e.category]+=parseFloat(e.amount)*(e.currency==='TWD'?1:(settings.rates[e.currency]||1))}); 
                return Object.entries(c).map(([k,v])=>({cat:k,amt:Math.round(v)})).filter(x=>x.amt>0).sort((a,b)=>b.amt-a.amt); 
            });

            const calculatedTransfers = computed(() => {
                const bal={}; settings.travelers.forEach(t=>bal[t]=0);
                expenses.value.forEach(e=>{ const amt=Math.round(parseFloat(e.amount)*(e.currency==='TWD'?1:(settings.rates[e.currency]||1))); const split=amt/e.forWhom.length; if(bal[e.payer]!==undefined) bal[e.payer]+=amt; e.forWhom.forEach(p=>{if(bal[p]!==undefined)bal[p]-=split}); });
                const d=[],c=[]; Object.entries(bal).forEach(([n,v])=>{if(v<-1)d.push({n,v});else if(v>1)c.push({n,v})}); d.sort((a,b)=>a.v-b.v); c.sort((a,b)=>b.v-a.v);
                const t=[]; let i=0,j=0; while(i<d.length&&j<c.length){ const amt=Math.min(Math.abs(d[i].v),c[j].v); if(amt>0)t.push({from:d[i].n,to:c[j].n,amount:Math.round(amt)}); d[i].v+=amt; c[j].v-=amt; if(Math.abs(d[i].v)<1)i++; if(c[j].v<1)j++; } return t;
            });

            const saveToLocal = (s=true) => { localStorage.setItem(STORAGE_KEY, JSON.stringify({ settings, flights, itineraryData: itineraryData.value, expenses: expenses.value, todoList: todoList.value, shoppingList: shoppingList.value, infoList: infoList.value })); if(s){autoSaveStatus.value=true;setTimeout(()=>autoSaveStatus.value=false,2000);} };
            const loadFromLocal = () => {
                const d = JSON.parse(localStorage.getItem(STORAGE_KEY)); if(!d) { saveToLocal(false); return; }
                if(d.settings) Object.assign(settings, d.settings); if(d.flights) Object.assign(flights, d.flights);
                itineraryData.value=d.itineraryData||{}; expenses.value=d.expenses||[]; todoList.value=d.todoList||[]; shoppingList.value=d.shoppingList||[]; infoList.value=d.infoList||[];
                document.documentElement.style.setProperty('--theme-color', settings.color); nextTick(initSortable);
                if(!settings.travelers.includes(newExpense.payer)) { newExpense.payer=settings.travelers[0]; newExpense.forWhom=[...settings.travelers]; }
            };

            const switchView = (v) => { currentView.value=v; if(v==='itinerary') nextTick(initSortable); };
            const selectDay = (i) => { 
                selectedDayIdx.value=i; 
                nextTick(initSortable);
                if(i !== 'summary') {
                    if (i === -1) {
                        const d = new Date(settings.startDate); d.setDate(d.getDate() - 1);
                        newExpense.date = d.toISOString().split('T')[0];
                    } else {
                        newExpense.date = new Date(new Date(settings.startDate).getTime()+i*86400000).toISOString().split('T')[0]; 
                    }
                }
            };
            const changeColor = (c) => { settings.color=c; document.documentElement.style.setProperty('--theme-color', c); };
            const openItemModal = (item=null) => { editingItem.value=item; form.value = item ? {...item, hour:item.time.split(':')[0], minute:item.time.split(':')[1]} : {id:null, hour:'10', minute:'00', location:'', category:'activity', cost:null, note:'', sourceUrl:''}; urlInput.value=item?item.sourceUrl||'':''; modals.item=true; };
            const editItem = (i) => openItemModal(i);
            const saveItem = () => { if(!form.value.location)return alert("åœ°é»å¿…å¡«"); form.value.time=`${form.value.hour}:${form.value.minute}`; const list=itineraryData.value[selectedDayIdx.value]||[]; if(editingItem.value) Object.assign(list.find(i=>i.id===form.value.id), form.value); else { if(!itineraryData.value[selectedDayIdx.value])itineraryData.value[selectedDayIdx.value]=[]; itineraryData.value[selectedDayIdx.value].push({...form.value, id:Date.now()}); } modals.item=false; saveToLocal(); nextTick(initSortable); };
            const deleteItem = (id) => { if(confirm('åˆªé™¤?')) { itineraryData.value[selectedDayIdx.value]=itineraryData.value[selectedDayIdx.value].filter(i=>i.id!==id); saveToLocal(); } };
            
            const openFlightModal = (type, item=null) => { 
                editingFlightType.value = type; editingFlightItem.value = item;
                let f = (item && item.isFlight) ? item : (flights[type] || { code: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', date: '', arriveDate: '', depTz: 8, arriveTz: 8 });
                tempFlight.value={ ...f, hour: (f.time||'10:00').split(':')[0], minute: (f.time||'10:00').split(':')[1], arriveHour: (f.arriveTime||'12:30').split(':')[0], arriveMinute: (f.arriveTime||'12:30').split(':')[1], extra: [] }; modals.flight=true; 
            };
            const addFlightToDay = () => { editingFlightItem.value = null; editingFlightType.value = 'day_item'; const d = new Date(settings.startDate); d.setDate(d.getDate() + selectedDayIdx.value); tempFlight.value = { code: '', time: '10:00', arriveTime: '12:30', from: '', to: '', airline: '', date: d.toISOString().split('T')[0], arriveDate: d.toISOString().split('T')[0], depTz: 8, arriveTz: 8, hour: '10', minute: '00', arriveHour: '12', arriveMinute: '30', extra: [] }; modals.flight = true; };
            const saveFlight = () => { const fmt=(t)=>`${t.hour}:${t.minute}`, fmtA=(t)=>`${t.arriveHour}:${t.arriveMinute}`; tempFlight.value.time=fmt(tempFlight.value); tempFlight.value.arriveTime=fmtA(tempFlight.value); if (editingFlightType.value === 'dep' || editingFlightType.value === 'ret') { Object.assign(flights[editingFlightType.value], tempFlight.value); } else { const flightData = { ...tempFlight.value, isFlight: true, title: 'èˆªç­', type: 'day_item' }; if (editingFlightItem.value) { Object.assign(editingFlightItem.value, flightData); } else { if(!itineraryData.value[selectedDayIdx.value]) itineraryData.value[selectedDayIdx.value] = []; itineraryData.value[selectedDayIdx.value].push({ ...flightData, id: Date.now() }); } } modals.flight=false; saveToLocal(); };
            const removeFlightItem = () => { if (confirm("ç¢ºå®šç§»é™¤?")) { if (editingFlightItem.value) { itineraryData.value[selectedDayIdx.value] = itineraryData.value[selectedDayIdx.value].filter(i => i.id !== editingFlightItem.value.id); } modals.flight = false; saveToLocal(); } };
            const searchAirport = (q, t) => { if(!q||q.length<1){suggestions.list=[];return;} const k=q.toUpperCase(); suggestions.type=t; suggestions.list=airports.filter(a=>a.code.includes(k)||a.city.toUpperCase().includes(k)||a.cityZh.includes(k)).slice(0,5); };
            const selectAirport = (s, t, extraObj=null) => { const target = extraObj || tempFlight.value; if(t==='dep') { target.from=s.code; target.depTz=s.tz; } else if(t==='arr') { target.to=s.code; target.arriveTz=s.tz; } suggestions.list=[]; };
            const getFlightDuration = (i) => { if(!i.date||!i.arriveDate)return'--'; const d=new Date(i.arriveDate+'T'+i.arriveTime)-new Date(i.date+'T'+i.time)-((i.arriveTz-i.depTz)*3600000); if(d<0)return'éŒ¯èª¤'; return `${Math.floor(d/3600000)}h ${Math.floor((d%3600000)/60000)}m`; };
            const isNextDay = (i) => i.date&&i.arriveDate && new Date(i.arriveDate)>new Date(i.date);
            const getDayDiff = (i) => Math.round((new Date(i.arriveDate)-new Date(i.date))/86400000);

            const resetExpense = () => { editingExpenseId.value=null; Object.assign(newExpense, {id:null, item:'', amount:null, currency:'TWD', category:'food', payer:settings.travelers[0], forWhom:[...settings.travelers]}); selectDay(selectedDayIdx.value); }; 
            const saveExpense = () => { if(!newExpense.item||!newExpense.amount)return alert('è«‹å¡«å¯«å®Œæ•´'); const d={...newExpense, amount:parseFloat(newExpense.amount)}; if(editingExpenseId.value) expenses.value[expenses.value.findIndex(e=>e.id===editingExpenseId.value)]=d; else {d.id=Date.now(); expenses.value.unshift(d);} resetExpense(); saveToLocal(); };
            const editExpense = (e) => { editingExpenseId.value=e.id; Object.assign(newExpense, JSON.parse(JSON.stringify(e))); };
            const deleteExpense = (id) => { if(confirm('åˆªé™¤?')) { expenses.value=expenses.value.filter(e=>e.id!==id); saveToLocal(); } };
            const toggleSplit = (p) => { const i=newExpense.forWhom.indexOf(p); i>-1?newExpense.forWhom.splice(i,1):newExpense.forWhom.push(p); };
            
            const addTodo = () => { todoList.value.push({id:Date.now(), text:'', done:false}); saveToLocal(); };
            const deleteTodo = (id) => { todoList.value=todoList.value.filter(t=>t.id!==id); saveToLocal(); };
            const addShopItem = () => { if(newShopItem.value){shoppingList.value.push({id:Date.now(), text:newShopItem.value, done:false}); newShopItem.value=''; saveToLocal();} };
            const deleteShopItem = (id) => { shoppingList.value=shoppingList.value.filter(i=>i.id!==id); saveToLocal(); };
            const saveInfo = () => { if(!newInfo.title)return; const d={...newInfo}; if(editingInfoId.value)infoList.value[infoList.value.findIndex(i=>i.id===editingInfoId.value)]=d; else {d.id=Date.now(); infoList.value.unshift(d);} editingInfoId.value=null; newInfo.title=''; newInfo.content=''; saveToLocal(); };
            const editInfo = (i) => { editingInfoId.value=i.id; newInfo.title=i.title; newInfo.content=i.content; };
            const deleteInfo = (id) => { if(confirm('åˆªé™¤?')){infoList.value=infoList.value.filter(i=>i.id!==id); saveToLocal();} };
            const addTraveler = () => { if(newTravelerName.value&&!settings.travelers.includes(newTravelerName.value)){settings.travelers.push(newTravelerName.value); newTravelerName.value=''; saveToLocal();} };
            const removeTraveler = (i) => { if(settings.travelers.length>1&&confirm('ç§»é™¤?')){settings.travelers.splice(i,1); saveToLocal();} };

            const initSortable = () => { if(sortableList.value && currentView.value==='itinerary' && selectedDayIdx.value > -1 && selectedDayIdx.value !== 'summary'){ if(sortableList.value.sortable)sortableList.value.sortable.destroy(); sortableList.value.sortable=Sortable.create(sortableList.value, {animation:150, handle:'.handle', filter:'.flight-card', onUpdate:e=>{const l=itineraryData.value[selectedDayIdx.value]; l.splice(e.newIndex,0,l.splice(e.oldIndex,1)[0]); saveToLocal();}}); } };
            const getCategoryColor = (c) => ({travel:'border-l-blue-400', food:'border-l-red-400', accommodation:'border-l-green-400', activity:'border-l-yellow-400', shopping:'border-l-purple-400', other:'border-l-gray-400'}[c]||'border-l-gray-400');
            const getCategoryIcon = (c) => ({travel:'fa-solid fa-plane-departure', food:'fa-solid fa-utensils', accommodation:'fa-solid fa-bed', activity:'fa-solid fa-person-running', shopping:'fa-solid fa-bag-shopping', other:'fa-solid fa-lightbulb'}[c]||'fa-solid fa-lightbulb');
            const getCategoryHex = (c) => ({food:'#F87171', traffic:'#60A5FA', accommodation:'#34D399', shopping:'#A78BFA', entertainment:'#FBBF24', other:'#9CA3AF'}[c]||'#9CA3AF');
            const getCategoryLabel = (c) => categoryLabels[c] || 'å…¶ä»–';
            const getNavUrl = (i) => i.sourceUrl || `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.location)}`;
            const getBudgetColorClass = () => { const p=tripStats.value.percentage; return p<50?'text-green-500':p<80?'text-yellow-600':p<100?'text-orange-500':'text-red-500'; };
            const getBudgetBgClass = () => { const p=tripStats.value.percentage; return p<50?'bg-green-500':p<80?'bg-yellow-500':p<100?'bg-orange-500':'bg-red-500'; };
            const fetchWeather = async () => { weather.loading=true; navigator.geolocation.getCurrentPosition(async p=>{ try{const r=await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true&daily=precipitation_probability_max&timezone=auto`);const d=await r.json();weather.temp=Math.round(d.current_weather.temperature);weather.rain=d.daily.precipitation_probability_max[0];weather.icon=d.current_weather.weathercode<=3?'fa-solid fa-sun':'fa-solid fa-cloud-rain';weather.desc=d.current_weather.weathercode<=3?'æ™´/å¤šé›²':'é›¨å¤©';const rl=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}&accept-language=zh-TW`);const dl=await rl.json();weather.location=dl.address.city||dl.address.town;}catch(e){weather.desc='å¤±æ•—';}weather.loading=false; }); };
            const updateRates = async () => { try{const r=await fetch('https://v6.exchangerate-api.com/v6/latest/TWD');const d=await r.json();if(d.result==='success')Object.keys(settings.rates).forEach(c=>{if(d.conversion_rates[c])settings.rates[c]=1/d.conversion_rates[c]});alert('æ›´æ–°æˆåŠŸ');saveToLocal();}catch(e){alert('å¤±æ•—');} };
            const parseUrl = async () => { if(!urlInput.value)return; form.value.sourceUrl=urlInput.value; const m=urlInput.value.match(/center=(-?\d+\.\d+)%2C(-?\d+\.\d+)/); if(m){const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${m[1]}&lon=${m[2]}&accept-language=zh-TW`);const d=await r.json();if(d.name)autoFilledName.value=d.name;} urlStatus.value='success'; };
            
            // ä¿®å¾©ç¿»è­¯åŠŸèƒ½ï¼šæ”¹ç”¨ zh-TW ä½œç‚º source é¿å… AUTO éŒ¯èª¤
            const translate = async () => { 
                if(!transText.value||transText.value.length<1)return; 
                try{
                    const j=await(await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transText.value)}&langpair=zh-TW|ja`)).json();
                    translations.ja=j.responseData.translatedText;
                    
                    const e=await(await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transText.value)}&langpair=zh-TW|en`)).json();
                    translations.en=e.responseData.translatedText;
                    
                    const k=await(await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(transText.value)}&langpair=zh-TW|ko`)).json();
                    translations.ko=k.responseData.translatedText;
                }catch(e){
                    console.error(e);
                } 
            };

            const debouncedTranslate = () => { clearTimeout(transTimeout); transTimeout=setTimeout(translate,500); };
            const speak = (t,l) => { const u=new SpeechSynthesisUtterance(t); u.lang=l; speechSynthesis.speak(u); };
            const exportData = () => { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify({settings,flights,itineraryData:itineraryData.value,expenses:expenses.value,todoList:todoList.value,shoppingList:shoppingList.value,infoList:infoList.value})],{type:"application/json"})); a.download='backup.json'; a.click(); };
            const triggerImport = () => { if(fileInput.value) fileInput.value.click(); };
            const handleImport = (e) => { const r=new FileReader(); r.onload=ev=>{const d=JSON.parse(ev.target.result);Object.assign(settings,d.settings);Object.assign(flights,d.flights);itineraryData.value=d.itineraryData;expenses.value=d.expenses;todoList.value=d.todoList;shoppingList.value=d.shoppingList;infoList.value=d.infoList;saveToLocal(false);location.reload();}; r.readAsText(e.target.files[0]); };
            const resetData = () => { if(confirm('é‡ç½®?')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } };
            const generateDayRoute = () => { const pts=currentItinerary.value.filter(i=>i.location||i.to).map(i=>i.isFlight?i.to:i.location); if(pts.length>1) window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(pts[0])}&destination=${encodeURIComponent(pts[pts.length-1])}&waypoints=${pts.slice(1,-1).map(p=>encodeURIComponent(p)).join('|')}`); };
            
            const copyItinerary = () => { 
                let t = `ã€${settings.title}ã€‘\nğŸ“… ${settings.startDate} ~ ${settings.endDate}\n\n`;
                computedDates.value.forEach((dateObj, idx) => {
                    t += `----------\n${dateObj.dayLabel} - ${dateObj.dateLabel}\n`;
                    let items = [...(itineraryData.value[idx] || [])];
                    if(idx === 0 && flights.dep.code) items.push({isFlight:true, ...flights.dep});
                    if(idx === computedDates.value.length-1 && flights.ret.code) items.push({isFlight:true, ...flights.ret});
                    items.sort((a,b) => (a.time||'00:00').localeCompare(b.time||'00:00'));
                    
                    if(items.length === 0) t += `(ç„¡è¡Œç¨‹)\n`;
                    else {
                        items.forEach(i => {
                            if(i.isFlight) t += `âœˆï¸ ${i.time} ${i.code||''} ${i.from||''}â†’${i.to||''}\n`;
                            else {
                                t += `ğŸ“ ${i.time} ${i.location}\n`;
                                if(i.note) t+= `   ğŸ“ ${i.note}\n`;
                            }
                        });
                    }
                    t += `\n`;
                });
                navigator.clipboard.writeText(t).then(() => alert('å®Œæ•´è¡Œç¨‹å·²è¤‡è£½ï¼')); 
            };
            
            const importPackingList = () => { ["è­·ç…§","ç¶²å¡","å……é›»å™¨","è¡£ç‰©","è—¥å“"].forEach(t=>todoList.value.push({id:Date.now()+Math.random(),text:t,done:false})); saveToLocal(); };
            const planRouteFromPrev = (i,idx) => { const p=currentItinerary.value[idx-1]; if(p) window.open(`https://www.google.com/maps/dir/${encodeURIComponent(p.isFlight?p.to:p.location)}/${encodeURIComponent(i.location)}`); };
            const cancelEditExpense = () => resetExpense(); const cancelEditInfo = () => { editingInfoId.value=null; newInfo.title=''; newInfo.content=''; }; const editBudget = () => { modals.budget=false; saveToLocal(); };
            const openFullscreen = (t) => { fullscreenText.value=t; modals.fullscreen=true; };

            watch(settings, ()=>saveToLocal(), {deep:true}); watch(flights, ()=>saveToLocal(), {deep:true});
            onMounted(() => { 
                loadFromLocal(); 
                fetchWeather(); 
                const mask = document.getElementById('loading-mask');
                if(mask) mask.style.display = 'none';
            });

            return { 
                settings, computedDates, currentItinerary, currentView, selectedDayIdx, form, editingItem, editingFlightItem, urlInput, urlStatus, autoFilledName, itineraryData, expenses, todoList, shoppingList, infoList, newExpense, newShopItem, newInfo, transText, translations, fullscreenText, flights, tempFlight, editingFlightType, dayTotalTwd, categories, tripTotalTwd, tripStats, switchView, selectDay, changeColor, openItemModal, editItem, saveItem, deleteItem, saveExpense, editExpense, cancelEditExpense, editingExpenseId, deleteExpense, addTodo, deleteTodo, addShopItem, deleteShopItem, saveInfo, editInfo, cancelEditInfo, deleteInfo, editingInfoId, parseUrl, getCategoryColor, getCategoryIcon, getNavUrl, getCategoryLabel, getCategoryHex, openFlightModal, saveFlight, addFlightToDay, removeFlightItem, openFullscreen, debouncedTranslate, speak, sortableList, updateRates, exportData, resetData, weather, fetchWeather, calcInput, calcResult, calcCurrency, modals, autoSaveStatus, fileInput, triggerImport, handleImport, addTraveler, removeTraveler, newTravelerName, calculatedTransfers, toggleSplit, editBudget, getBudgetColorClass, getBudgetBgClass, generateDayRoute, copyItinerary, importPackingList, planRouteFromPrev, getFlightDuration, isNextDay, getDayDiff, suggestions, searchAirport, selectAirport, isPickingLocation: ref(false),
                currentDayExpenses, filteredSummaryExpenses, summaryFilter, categoryLabels
            };
        }
    });
    
    app.config.errorHandler = (err) => { 
        if(err.message && err.message.includes('ResizeObserver')) return;
        console.error(err); 
    };
    app.mount('#app');
</script>
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }
</script>
</body>
</html>```